<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loteca Pro - A Casa do Lotequeiro</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta property="og:image" content="/logo-full.png">
    
    <!-- EXTERNAL LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- CONFIGURAÇÃO TAILWIND -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        app: {
                            bg: '#0f172a', surface: '#1e293b', surfaceLight: '#334155',
                            primary: '#4ade80', secondary: '#facc15', danger: '#f87171',
                            text: '#f1f5f9', muted: '#94a3b8', ai: '#8b5cf6', google: '#202124'
                        }
                    },
                    fontFamily: { sans: ['system-ui', '-apple-system', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.2s ease-in', 'pulse-slow': 'pulse 3s infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
        .nav-item { transition: all 0.2s ease; }
        .nav-item.active { background-color: rgba(74, 222, 128, 0.1); color: #4ade80; border-bottom: 2px solid #4ade80; }
        
        /* OVERLAY DE PROGRESSO */
        .progress-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .progress-card {
            background: #1e293b; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 1rem; padding: 2rem; width: 90%; max-width: 480px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .step-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; }
        .step-icon {
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 14px;
            flex-shrink: 0; transition: all 0.3s ease;
        }
        .step-pending .step-icon { background: #334155; color: #64748b; }
        .step-active .step-icon { background: #3b82f6; color: white; animation: pulseStep 1.5s infinite; }
        .step-done .step-icon { background: #22c55e; color: white; }
        .step-error .step-icon { background: #ef4444; color: white; }
        .step-pending .step-label { color: #64748b; }
        .step-active .step-label { color: #93c5fd; font-weight: 600; }
        .step-done .step-label { color: #86efac; }
        .step-error .step-label { color: #fca5a5; }
        .step-sublabel { font-size: 0.7rem; color: #64748b; margin-top: 2px; }
        .step-active .step-sublabel { color: #60a5fa; }
        @keyframes pulseStep {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0.5); }
            50% { box-shadow: 0 0 0 8px rgba(59,130,246,0); }
        }
        .progress-bar-bg { background: #334155; height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill {
            height: 100%; border-radius: 3px; transition: width 0.5s ease;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #22c55e);
        }
        .timer-display { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="bg-app-bg text-app-text font-sans antialiased">

    <!-- ANÚNCIO SUPERIOR FIXO -->
    <div class="fixed top-0 left-0 w-full z-50 bg-black h-24 flex items-center justify-center border-b border-white/10">
        <span class="text-xs text-slate-500 uppercase font-bold tracking-widest animate-pulse">
            <i class="fas fa-ad mr-2"></i> Publicidade Premium (728x90)
        </span>
    </div>

    <!-- HEADER -->
    <header class="bg-app-surface/95 backdrop-blur-md fixed top-24 left-0 w-full z-40 border-b border-white/5 h-16 flex items-center justify-between px-6">
        <button onclick="Router.navigate('home')" class="flex items-center gap-3 focus:outline-none text-left group">
            <div class="bg-gradient-to-tr from-green-600 to-app-primary w-10 h-10 rounded-lg flex items-center justify-center shadow-lg shadow-green-500/20 group-hover:scale-105 transition-transform">
                <i class="fas fa-trophy text-black text-sm"></i>
            </div>
            <div class="flex flex-col">
                <h1 class="text-base font-bold tracking-tight leading-none text-white">
                    LOTECA<span class="text-app-primary">PRO</span>
                </h1>
                <span class="text-[9px] text-slate-400 font-medium tracking-wide">A casa do lotequeiro profissional!</span>
            </div>
        </button>
        <div id="header-user-area" class="text-right"></div>
    </header>

    <!-- MENU HORIZONTAL -->
    <nav class="fixed top-40 left-0 w-full z-30 bg-app-surface border-b border-white/5 shadow-xl">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-center gap-2 py-3 overflow-x-auto no-scrollbar" id="horizontal-menu"></div>
        </div>
    </nav>

    <!-- LAYOUT PRINCIPAL COM ANÚNCIOS LATERAIS -->
    <div class="pt-56 pb-10 min-h-screen">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-12 gap-6">
                <!-- ANÚNCIO LATERAL ESQUERDO -->
                <aside class="col-span-2 hidden lg:block">
                    <div class="sticky top-60 bg-black h-[600px] rounded-xl border border-white/10 flex items-center justify-center">
                        <span class="text-[10px] text-slate-600 uppercase font-bold tracking-widest rotate-90">
                            <i class="fas fa-ad mr-1"></i> 160x600
                        </span>
                    </div>
                </aside>

                <!-- CONTEÚDO PRINCIPAL -->
                <main class="col-span-12 lg:col-span-8" id="main-content"></main>

                <!-- ANÚNCIO LATERAL DIREITO -->
                <aside class="col-span-2 hidden lg:block">
                    <div class="sticky top-60 bg-black h-[600px] rounded-xl border border-white/10 flex items-center justify-center">
                        <span class="text-[10px] text-slate-600 uppercase font-bold tracking-widest rotate-90">
                            <i class="fas fa-ad mr-1"></i> 160x600
                        </span>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyATC9NA-pXbdc8pD8IWdEIxFZ3wh04nUrE",
            authDomain: "loteca-pro-mateus-1767825041.firebaseapp.com",
            projectId: "loteca-pro-mateus-1767825041",
            storageBucket: "loteca-pro-mateus-1767825041.firebasestorage.app",
            messagingSenderId: "1767825041",
            appId: "1:1767825041:web:abc123"
        };
        
        // Chave removida - agora usa Cloud Function
        
        let isFirebaseActive = false;
        try {
            if(!firebaseConfig.apiKey.includes("REPLACE")) {
                firebase.initializeApp(firebaseConfig);
                isFirebaseActive = true;
            }
        } catch(e) { console.error("Firebase Init Error", e); }

        // --- DATA ---
        const Data = {
            loaded: false,
            concursoAtual: null,
            games: [
                { id: 1, tour: "BRA A", date: "Sáb 16:30", home: { name: "Flamengo", short: "FLA" }, away: { name: "Palmeiras", short: "PAL" }, probs: { h: 45, d: 30, a: 25 }, comm: { h: 50, d: 30, a: 20 }, analysis: "O Flamengo vem de sequência invicta no Maracanã, enfrentando o líder Palmeiras." },
                { id: 2, tour: "BRA B", date: "Sáb 17:00", home: { name: "Santos", short: "SAN" }, away: { name: "Ceará", short: "CEA" }, probs: { h: 60, d: 25, a: 15 }, comm: { h: 70, d: 20, a: 10 }, analysis: "Santos absoluto na Vila Belmiro, busca manter 100% em casa." },
                { id: 3, tour: "ING", date: "Sáb 18:30", home: { name: "West Ham", short: "WHU" }, away: { name: "Chelsea", short: "CHE" }, probs: { h: 30, d: 30, a: 40 }, comm: { h: 25, d: 35, a: 40 }, analysis: "Derby londrino equilibrado. Chelsea vem de vitória na Champions." },
                { id: 4, tour: "ESP", date: "Dom 11:00", home: { name: "Sevilla", short: "SEV" }, away: { name: "Betis", short: "BET" }, probs: { h: 33, d: 34, a: 33 }, comm: { h: 30, d: 40, a: 30 }, analysis: "O 'Gran Derbi' de Sevilha. Sevilla em crise, mas joga em casa." },
                { id: 5, tour: "BRA A", date: "Dom 16:00", home: { name: "Vasco", short: "VAS" }, away: { name: "Fortaleza", short: "FOR" }, probs: { h: 40, d: 30, a: 30 }, comm: { h: 45, d: 25, a: 30 }, analysis: "Vasco pressionado em São Januário após 3 derrotas seguidas." },
                { id: 6, tour: "ITA", date: "Dom 16:00", home: { name: "Napoli", short: "NAP" }, away: { name: "Roma", short: "ROM" }, probs: { h: 50, d: 25, a: 25 }, comm: { h: 55, d: 25, a: 20 }, analysis: "Clássico italiano. Napoli favorito jogando no Diego Maradona." },
                { id: 7, tour: "BRA B", date: "Dom 18:00", home: { name: "Sport", short: "SPT" }, away: { name: "Bahia", short: "BAH" }, probs: { h: 35, d: 35, a: 30 }, comm: { h: 30, d: 40, a: 30 }, analysis: "Clássico do Nordeste. Equilíbrio total na Ilha do Retiro." },
                { id: 8, tour: "BRA A", date: "Dom 18:30", home: { name: "Atl-MG", short: "CAM" }, away: { name: "Cruzeiro", short: "CRU" }, probs: { h: 45, d: 35, a: 20 }, comm: { h: 40, d: 40, a: 20 }, analysis: "Clássico mineiro na Arena MRV. Galo busca vingança." },
                { id: 9, tour: "ALE", date: "Dom 11:30", home: { name: "Dortmund", short: "BVB" }, away: { name: "Leipzig", short: "RBL" }, probs: { h: 40, d: 20, a: 40 }, comm: { h: 35, d: 30, a: 35 }, analysis: "Jogo aberto na Alemanha. Dois ataques poderosos." },
                { id: 10, tour: "FRA", date: "Sáb 15:00", home: { name: "Lyon", short: "LYO" }, away: { name: "Marseille", short: "OM" }, probs: { h: 30, d: 40, a: 30 }, comm: { h: 25, d: 45, a: 30 }, analysis: "Lyon em crise profunda, mas o Olympique é sempre imprevisível." },
                { id: 11, tour: "BRA A", date: "Sáb 21:00", home: { name: "Botafogo", short: "BOT" }, away: { name: "Fluminense", short: "FLU" }, probs: { h: 35, d: 30, a: 35 }, comm: { h: 33, d: 33, a: 34 }, analysis: "Clássico Vovô sempre imprevisível. Nilton Santos lotado." },
                { id: 12, tour: "BRA B", date: "Sex 19:00", home: { name: "Goiás", short: "GOI" }, away: { name: "Vila Nova", short: "VIL" }, probs: { h: 55, d: 30, a: 15 }, comm: { h: 60, d: 25, a: 15 }, analysis: "Goiás foca no acesso. Vila Nova vem de 4 derrotas." },
                { id: 13, tour: "BRA A", date: "Dom 16:00", home: { name: "São Paulo", short: "SPA" }, away: { name: "Corinthians", short: "COR" }, probs: { h: 40, d: 40, a: 20 }, comm: { h: 35, d: 45, a: 20 }, analysis: "Majestoso no Morumbi. São Paulo invicto no clássico em 2025." },
                { id: 14, tour: "ESP 2", date: "Seg 16:00", home: { name: "Eibar", short: "EIB" }, away: { name: "Levante", short: "LEV" }, probs: { h: 33, d: 33, a: 34 }, comm: { h: 30, d: 40, a: 30 }, analysis: "Segundona espanhola. Triplo empate nas estatísticas." },
            ],
            analysis: {
                current: { 
                    id: 1105, 
                    acc: "1.5M", 
                    summary: "Concurso marcada por grandes clássicos regionais e derbies internacionais. Equilíbrio total nas estatísticas, com destaque para os confrontos brasileiros da Série A e B.",
                    openDate: "Quinta, 16/01 às 10h",
                    closeDate: "Sábado, 18/01 às 14h",
                    fullAnalysis: "O concurso 1105 traz uma grade recheada de clássicos que prometem muita emoção. No Brasil, destaque para Flamengo x Palmeiras, que pode definir a liderança do Brasileirão. O Majestoso entre São Paulo e Corinthians também é um dos pontos altos, com o Tricolor invicto no clássico em 2025. Na Europa, o Gran Derbi espanhol entre Sevilla e Betis promete fogo, assim como o duelo italiano entre Napoli e Roma. A concurso exige atenção especial aos jogos da Série B, onde Goiás e Santos aparecem como favoritos em casa, mas zebras são sempre possíveis.",
                    resumoCartela: null
                },
                previous: { 
                    id: 1104, 
                    summary: "Concurso de zebras! Apenas 2 favoritos venceram. 6 empates surpreenderam os apostadores. O concurso acumulou após ninguém cratar os 14 resultados.",
                    winners: 0,
                    winners13: 0,
                    accumulated: true,
                    fullAnalysis: "O concurso 1104 entrou para a história como uma das concursos mais imprevisíveis do ano. Com 6 empates (incluindo o surpreendente 2x2 entre Flamengo e Botafogo no Maracanã), os apostadores viram seus palpites ruírem. Apenas Santos e Palmeiras confirmaram o favoritismo, vencendo fora de casa. Na Europa, o Lyon surpreendeu ao vencer o PSG por 3x1, resultado que ninguém esperava. O resultado? Zero acertadores dos 14 jogos e prêmio acumulado para o próximo concurso. Análise detalhada de cada partida disponível abaixo.",
                    jogos: [],
                    analiseJogos: []
                }
            },
            mercado: {
                destaque: [],
                rumores: [],
                lesoes: [],
                impacto: ''
            },
            news: [
                { id: 1, teamId: 'cru', type: "chegada", title: "Gabigol no Cruzeiro", desc: "Empréstimo confirmado.", time: "2h", source: "ge", hot: true },
                { id: 2, teamId: 'san', type: "renovacao", title: "Neymar Fica", desc: "Até 2026.", time: "5h", source: "UOL", hot: true },
            ],
            ranking: {
                round: [
                    { name: "MestreLoteca", points: 14, hits: 14, avatar: "ML" },
                    { name: "DoutorZebra", points: 13, hits: 13, avatar: "DZ" },
                    { name: "ReiDoTriplo", points: 12, hits: 12, avatar: "RT" },
                    { name: "CraqueDoVolante", points: 11, hits: 11, avatar: "CV" },
                    { name: "ZebraHunter", points: 10, hits: 10, avatar: "ZH" },
                    { name: "PalpiteiroMor", points: 10, hits: 10, avatar: "PM" },
                    { name: "LotecaLegend", points: 9, hits: 9, avatar: "LL" },
                    { name: "AcertouTudo", points: 9, hits: 9, avatar: "AT" },
                    { name: "BolãoMaster", points: 8, hits: 8, avatar: "BM" },
                    { name: "GanhadorNato", points: 8, hits: 8, avatar: "GN" }
                ],
                month: [
                    { name: "MestreLoteca", points: 142, hits: 142, rounds: 12, avatar: "ML" },
                    { name: "DoutorZebra", points: 138, hits: 138, rounds: 12, avatar: "DZ" },
                    { name: "ReiDoTriplo", points: 135, hits: 135, rounds: 12, avatar: "RT" },
                    { name: "CraqueDoVolante", points: 130, hits: 130, rounds: 11, avatar: "CV" },
                    { name: "ZebraHunter", points: 128, hits: 128, rounds: 11, avatar: "ZH" },
                    { name: "PalpiteiroMor", points: 125, hits: 125, rounds: 11, avatar: "PM" },
                    { name: "LotecaLegend", points: 122, hits: 122, rounds: 10, avatar: "LL" },
                    { name: "AcertouTudo", points: 120, hits: 120, rounds: 10, avatar: "AT" },
                    { name: "BolãoMaster", points: 118, hits: 118, rounds: 10, avatar: "BM" },
                    { name: "GanhadorNato", points: 115, hits: 115, rounds: 9, avatar: "GN" }
                ],
                year: [
                    { name: "MestreLoteca", points: 1420, hits: 1420, rounds: 120, avatar: "ML" },
                    { name: "DoutorZebra", points: 1380, hits: 1380, rounds: 118, avatar: "DZ" },
                    { name: "ReiDoTriplo", points: 1350, hits: 1350, rounds: 115, avatar: "RT" },
                    { name: "CraqueDoVolante", points: 1300, hits: 1300, rounds: 112, avatar: "CV" },
                    { name: "ZebraHunter", points: 1280, hits: 1280, rounds: 110, avatar: "ZH" },
                    { name: "PalpiteiroMor", points: 1250, hits: 1250, rounds: 108, avatar: "PM" },
                    { name: "LotecaLegend", points: 1220, hits: 1220, rounds: 105, avatar: "LL" },
                    { name: "AcertouTudo", points: 1200, hits: 1200, rounds: 102, avatar: "AT" },
                    { name: "BolãoMaster", points: 1180, hits: 1180, rounds: 100, avatar: "BM" },
                    { name: "GanhadorNato", points: 1150, hits: 1150, rounds: 98, avatar: "GN" }
                ]
            }
        };

        // --- STORE ---
        const Store = {
            KEY_USER: 'loteca_user',
            KEY_DATA: 'loteca_app_data',
            getUser: () => JSON.parse(localStorage.getItem(Store.KEY_USER)),
            saveUser: (user) => localStorage.setItem(Store.KEY_USER, JSON.stringify(user)),
            getAppData: () => JSON.parse(localStorage.getItem(Store.KEY_DATA)) || { votes: {}, submitted: false },
            saveAppData: (data) => localStorage.setItem(Store.KEY_DATA, JSON.stringify(data)),
            setVote: (gid, type) => {
                const d = Store.getAppData();
                d.votes[gid] = type;
                Store.saveAppData(d);
            }
        };

        // --- AUTH ---
        const Auth = {
            user: Store.getUser(),
            init: () => {
                if(isFirebaseActive) {
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            Auth.user = { name: user.displayName, email: user.email, avatar: user.displayName.substring(0,2).toUpperCase(), points: { total: 0 } };
                            Store.saveUser(Auth.user);
                        } else {
                            Auth.user = Store.getUser();
                        }
                        Auth.renderHeader();
                        Router.render();
                    });
                } else {
                    Auth.user = Store.getUser();
                    Auth.renderHeader();
                }
            },
            loginWithGoogle: () => {
                if(!isFirebaseActive) {
                    alert("Firebase não configurado. Usando login simulado.");
                    Router.openModal('login');
                    return;
                }
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider).catch(e => alert("Erro no login: " + e.message));
            },
            logout: () => {
                if(isFirebaseActive) firebase.auth().signOut();
                localStorage.removeItem(Store.KEY_USER);
                Auth.user = null;
                Router.render();
            },
            renderHeader: () => {
                const area = document.getElementById('header-user-area');
                if(Auth.user) {
                    area.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="text-xs font-bold text-white leading-none">${Auth.user.name}</div>
                                <button onclick="Auth.logout()" class="text-[9px] font-bold text-slate-500 hover:text-app-danger uppercase">Sair</button>
                            </div>
                            <div class="w-9 h-9 rounded-full bg-app-primary flex items-center justify-center text-xs font-black text-black">${Auth.user.avatar}</div>
                        </div>
                    `;
                } else {
                    area.innerHTML = `<button onclick="Router.openModal('login')" class="bg-white/5 hover:bg-white/10 text-white text-xs font-black px-5 py-2 rounded-full border border-white/10 transition-all">ENTRAR</button>`;
                }
            }
        };

        // --- VIEWS ---
        const Views = {
            Home: () => `
                <div class="animate-fade-in space-y-6">
                    <!-- CONCURSO ANTERIOR -->
                    <section class="bg-app-surface p-5 rounded-xl border border-white/5 shadow-lg">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Concurso Anterior #${Data.analysis.previous.id}</span>
                            <span class="text-xs font-black ${Data.analysis.previous.accumulated ? 'text-app-primary' : 'text-slate-400'}">${Data.analysis.previous.accumulated ? 'ACUMULOU!' : Data.analysis.previous.winners + ' Ganhadores'}</span>
                        </div>
                        <p class="text-sm text-slate-300 mb-4 leading-relaxed">${Data.analysis.previous.summary}</p>
                        <button onclick="Router.navigate('analysis-previous')" class="w-full py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-bold text-white transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-chart-line"></i> ANÁLISE DETALHADA
                        </button>
                    </section>

                    <!-- PRÓXIMO CONCURSO -->
                    <section class="bg-gradient-to-br from-app-surface to-app-bg p-6 rounded-2xl border border-app-primary/20 shadow-2xl relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="bg-app-primary text-black text-[10px] font-black px-3 py-1 rounded-full uppercase">Aberto</span>
                                <span class="text-xs font-bold text-slate-400 uppercase">Concurso #${Data.analysis.current.id}</span>
                            </div>
                            <h2 class="text-4xl font-black text-white mb-2">${Data.analysis.current.acc.startsWith('R$') ? Data.analysis.current.acc : 'R$ ' + Data.analysis.current.acc}</h2>
                            <p class="text-sm text-slate-300 mb-4 leading-relaxed">${Data.analysis.current.summary}</p>
                            <div class="grid grid-cols-2 gap-3 mb-4 text-xs">
                                <div class="bg-black/20 p-3 rounded-lg">
                                    <span class="text-slate-500 block mb-1">Abertura</span>
                                    <span class="text-white font-bold">${Data.analysis.current.openDate}</span>
                                </div>
                                <div class="bg-black/20 p-3 rounded-lg">
                                    <span class="text-slate-500 block mb-1">Encerramento</span>
                                    <span class="text-white font-bold">${Data.analysis.current.closeDate}</span>
                                </div>
                            </div>
                            <button onclick="Router.navigate('analysis-current')" class="w-full bg-app-primary hover:bg-green-400 text-black font-black py-4 px-6 rounded-xl shadow-lg shadow-green-500/20 transition-all active:scale-95 flex items-center justify-center gap-2 text-sm">
                                VER ANÁLISE E PALPITES <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        <i class="fas fa-trophy absolute -right-8 -bottom-8 text-9xl text-white/5 -rotate-12"></i>
                    </section>

                    <!-- TABELA DO CONCURSO -->
                    <div class="bg-app-surface rounded-xl border border-white/5 overflow-hidden shadow-xl">
                        <div class="p-4 border-b border-white/5 flex justify-between items-center bg-black/20">
                            <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest">Grade de Jogos - Concurso #${Data.analysis.current.id}</h3>
                            <button onclick="Router.navigate('palpites')" class="text-xs font-bold text-app-primary hover:underline flex items-center gap-2">
                                Dê o seu palpite e veja a aposta dos usuários <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="divide-y divide-white/5">
                            ${Data.games.map(g => `
                                <div class="p-3 flex items-center gap-4 hover:bg-white/[0.02] transition-colors">
                                    <span class="text-xs font-black text-slate-600 w-6">${g.id}</span>
                                    <div class="flex-1 grid grid-cols-3 items-center text-center gap-2">
                                        <span class="text-right text-sm font-bold text-white uppercase truncate">${g.home.name}</span>
                                        <span class="text-xs text-slate-600 font-black">X</span>
                                        <span class="text-left text-sm font-bold text-white uppercase truncate">${g.away.name}</span>
                                    </div>
                                    <span class="text-[10px] text-slate-500 w-20 text-right">${g.date}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `,
            AnalysisPrevious: () => {
                const prev = Data.analysis.previous;
                const jogos = prev.jogos && prev.jogos.length > 0 ? prev.jogos : [];
                const analiseJogos = prev.analiseJogos && prev.analiseJogos.length > 0 ? prev.analiseJogos : [];
                
                return `
                <div class="animate-fade-in space-y-6">
                    <button onclick="Router.navigate('home')" class="text-xs text-slate-400 hover:text-white flex items-center gap-2 mb-4">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    
                    <!-- ANÁLISE GERAL -->
                    <div class="bg-app-surface p-6 rounded-2xl border border-white/5 shadow-2xl">
                        <div class="flex items-center gap-3 mb-4">
                            <i class="fas fa-chart-line text-app-primary text-xl"></i>
                            <h2 class="text-2xl font-black text-white">Análise Completa - Concurso #${prev.id}</h2>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-6">
                            ${prev.accumulated ? 
                                '<span class="text-xs font-bold text-app-primary bg-green-500/10 border border-green-500/20 px-3 py-1.5 rounded-full"><i class="fas fa-arrow-trend-up mr-1"></i>ACUMULOU!</span>' :
                                `<span class="text-xs font-bold text-slate-400 bg-black/30 px-3 py-1.5 rounded-full"><i class="fas fa-trophy mr-1"></i>${prev.winners} Ganhador${prev.winners !== 1 ? 'es' : ''} (14 acertos)</span>`
                            }
                            ${prev.winners13 > 0 ? 
                                `<span class="text-xs font-bold text-slate-500 bg-black/30 px-3 py-1.5 rounded-full">${prev.winners13} com 13 acertos</span>` : ''
                            }
                        </div>
                        <div class="prose prose-invert max-w-none bg-black/20 p-5 rounded-xl">
                            <p class="text-sm text-slate-300 leading-relaxed whitespace-pre-line">${prev.fullAnalysis}</p>
                        </div>
                    </div>
                    
                    <!-- RESULTADOS DOS JOGOS COM ANÁLISE INDIVIDUAL -->
                    ${jogos.length > 0 ? `
                    <div class="bg-app-surface p-6 rounded-2xl border border-white/5">
                        <div class="flex items-center gap-3 mb-6">
                            <i class="fas fa-futbol text-app-secondary text-xl"></i>
                            <h3 class="text-lg font-black text-white">Resultado e Análise de Cada Partida</h3>
                        </div>
                        <div class="space-y-4">
                            ${jogos.map((jogo, idx) => {
                                const placar = jogo.placar1 !== undefined && jogo.placar2 !== undefined ? 
                                    `${jogo.placar1} x ${jogo.placar2}` : 'vs';
                                const resultado = jogo.placar1 > jogo.placar2 ? 'Col. 1' : 
                                                 jogo.placar1 < jogo.placar2 ? 'Col. 2' : 'Empate';
                                const corResultado = jogo.placar1 > jogo.placar2 ? 'text-green-400' : 
                                                    jogo.placar1 < jogo.placar2 ? 'text-red-400' : 'text-yellow-400';
                                const bgResultado = jogo.placar1 > jogo.placar2 ? 'bg-green-500/10 border-green-500/20' : 
                                                    jogo.placar1 < jogo.placar2 ? 'bg-red-500/10 border-red-500/20' : 'bg-yellow-500/10 border-yellow-500/20';
                                
                                // Buscar análise individual deste jogo
                                const analiseJogo = analiseJogos.find(a => a.jogo === (idx + 1));
                                const textoAnalise = analiseJogo ? analiseJogo.analise : '';
                                
                                return `
                                <div class="bg-black/20 p-4 rounded-xl hover:bg-black/30 transition-colors border border-white/5">
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs font-black text-slate-600 bg-black/30 w-8 h-8 rounded-full flex items-center justify-center">${idx + 1}</span>
                                            <div>
                                                <div class="text-sm font-bold text-white">
                                                    ${jogo.time1} <span class="text-app-primary font-black mx-2">${placar}</span> ${jogo.time2}
                                                </div>
                                                ${jogo.data ? `<div class="text-xs text-slate-500 mt-0.5"><i class="far fa-calendar mr-1"></i>${jogo.data}</div>` : ''}
                                            </div>
                                        </div>
                                        <span class="text-xs font-bold ${corResultado} ${bgResultado} border px-3 py-1.5 rounded-full">${resultado}</span>
                                    </div>
                                    ${textoAnalise ? `
                                    <div class="mt-3 pt-3 border-t border-white/5">
                                        <p class="text-xs text-slate-400 leading-relaxed"><i class="fas fa-microchip text-app-ai mr-1.5"></i>${textoAnalise}</p>
                                    </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="bg-app-surface p-6 rounded-2xl border border-white/5 text-center">
                        <i class="fas fa-info-circle text-slate-600 text-3xl mb-3"></i>
                        <p class="text-sm text-slate-400">Resultados detalhados não disponíveis para este concurso.</p>
                    </div>
                    `}
                </div>
                `;
            },
            AnalysisCurrent: () => {
                const renderHistorico = (hist) => {
                    if (!hist) return '';
                    return hist.split(',').map(r => {
                        const t = r.trim().toUpperCase();
                        if (t === 'V') return '<span class="inline-flex w-6 h-6 rounded-full bg-green-500 text-black text-[10px] font-black items-center justify-center">V</span>';
                        if (t === 'E') return '<span class="inline-flex w-6 h-6 rounded-full bg-yellow-500 text-black text-[10px] font-black items-center justify-center">E</span>';
                        return '<span class="inline-flex w-6 h-6 rounded-full bg-red-500 text-black text-[10px] font-black items-center justify-center">D</span>';
                    }).join('');
                };
                const renderRisco = (risco) => {
                    const r = (risco || '').toLowerCase();
                    if (r === 'baixo') return '<span class="text-[10px] font-bold text-green-400 bg-green-500/20 border border-green-500/30 px-2 py-0.5 rounded-full">BAIXO</span>';
                    if (r === 'alto') return '<span class="text-[10px] font-bold text-red-400 bg-red-500/20 border border-red-500/30 px-2 py-0.5 rounded-full">ALTO</span>';
                    return '<span class="text-[10px] font-bold text-yellow-400 bg-yellow-500/20 border border-yellow-500/30 px-2 py-0.5 rounded-full">MEDIO</span>';
                };
                const renderPalpite = (p) => {
                    if (p === '1') return '<span class="text-[10px] font-black text-green-400 bg-green-500/20 border border-green-500/30 px-2 py-0.5 rounded-lg">COL 1</span>';
                    if (p === 'X' || p === 'x') return '<span class="text-[10px] font-black text-yellow-400 bg-yellow-500/20 border border-yellow-500/30 px-2 py-0.5 rounded-lg">EMP</span>';
                    if (p === '2') return '<span class="text-[10px] font-black text-red-400 bg-red-500/20 border border-red-500/30 px-2 py-0.5 rounded-lg">COL 2</span>';
                    return '';
                };
                const renderConfianca = (c) => {
                    const val = c || 50;
                    const cor = val >= 75 ? 'bg-green-500' : (val >= 60 ? 'bg-yellow-500' : 'bg-orange-500');
                    return `<div class="flex items-center gap-2"><div class="flex-1 h-1.5 bg-black/40 rounded-full overflow-hidden"><div class="h-full ${cor} rounded-full" style="width:${val}%"></div></div><span class="text-[10px] font-bold text-slate-400">${val}%</span></div>`;
                };
                const jogosChave = (Data.analysis.current.resumoCartela && Data.analysis.current.resumoCartela.jogosChave) || [];
                return `
                <div class="animate-fade-in space-y-6">
                    <button onclick="Router.navigate('home')" class="text-xs text-slate-400 hover:text-white flex items-center gap-2 mb-4">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <div class="bg-gradient-to-br from-app-surface to-app-bg p-6 rounded-2xl border border-app-primary/20 shadow-2xl">
                        <h2 class="text-2xl font-black text-white mb-2">Previa do Concurso #${Data.analysis.current.id}</h2>
                        <h3 class="text-3xl font-black text-app-primary mb-6">${Data.analysis.current.acc.startsWith('R$') ? Data.analysis.current.acc : 'R$ ' + Data.analysis.current.acc}</h3>
                        <div class="prose prose-invert max-w-none mb-6">
                            <p class="text-sm text-slate-300 leading-relaxed">${Data.analysis.current.fullAnalysis}</p>
                        </div>
                        <button onclick="Router.navigate('ai-xray')" class="w-full bg-app-ai hover:bg-purple-600 text-white font-black py-4 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-microchip"></i> VER RAIO X IA (ANALISE PREMIUM)
                        </button>
                    </div>
                    <div class="bg-app-surface p-6 rounded-2xl border border-white/5">
                        <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-futbol text-app-primary mr-2"></i>Analise de Cada Confronto</h3>
                        <p class="text-[10px] text-slate-500 mb-4">Clique em cada jogo para ver a analise completa com historico, odds e contexto.</p>
                        <div class="space-y-3">
                            ${Data.games.map((g, idx) => {
                                const isChave = jogosChave.includes(g.id);
                                return `
                                <div class="bg-black/20 rounded-xl border ${isChave ? 'border-app-ai/40' : 'border-white/5'} overflow-hidden">
                                    <div class="p-4 cursor-pointer hover:bg-black/30 transition-colors" onclick="document.getElementById('jogo-detail-${g.id}').classList.toggle('hidden');this.querySelector('.fa-chevron-down,.fa-chevron-up').classList.toggle('fa-chevron-down');this.querySelector('.fa-chevron-down,.fa-chevron-up').classList.toggle('fa-chevron-up')">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-3">
                                                <span class="text-xs font-black text-slate-600 bg-black/30 w-7 h-7 rounded-full flex items-center justify-center">${g.id}</span>
                                                <div>
                                                    <div class="text-sm font-bold text-white">${g.home.name} <span class="text-slate-500 mx-1">x</span> ${g.away.name}</div>
                                                    <div class="text-[10px] text-slate-500">${g.tour} - ${g.date}</div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                ${g.palpiteIA ? renderPalpite(g.palpiteIA) : ''}
                                                ${g.riscoZebra ? renderRisco(g.riscoZebra) : ''}
                                                ${isChave ? '<span class="text-[10px] text-app-ai" title="Jogo-chave"><i class="fas fa-star"></i></span>' : ''}
                                                <i class="fas fa-chevron-down text-slate-600 text-xs ml-1"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="jogo-detail-${g.id}" class="hidden border-t border-white/5 p-4 space-y-3">
                                        ${g.historicoCasa || g.historicoFora ? `
                                        <div class="bg-black/20 p-3 rounded-lg">
                                            <div class="text-[10px] font-bold text-slate-500 uppercase mb-2"><i class="fas fa-chart-line mr-1"></i>Historico (Ultimos 5)</div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <div class="text-[10px] text-slate-500 mb-1">${g.home.short}</div>
                                                    <div class="flex gap-1">${renderHistorico(g.historicoCasa)}</div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-[10px] text-slate-500 mb-1">${g.away.short}</div>
                                                    <div class="flex gap-1 justify-end">${renderHistorico(g.historicoFora)}</div>
                                                </div>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${g.consensoMercado ? `
                                        <div class="bg-black/20 p-3 rounded-lg">
                                            <div class="text-[10px] font-bold text-slate-500 uppercase mb-1"><i class="fas fa-chart-bar mr-1"></i>Consenso do Mercado</div>
                                            <p class="text-xs text-slate-400 leading-relaxed">${g.consensoMercado}</p>
                                        </div>
                                        ` : ''}
                                        ${g.contextoLocal ? `
                                        <div class="bg-black/20 p-3 rounded-lg">
                                            <div class="text-[10px] font-bold text-slate-500 uppercase mb-1"><i class="fas fa-newspaper mr-1"></i>Contexto Local</div>
                                            <p class="text-xs text-slate-400 leading-relaxed">${g.contextoLocal}</p>
                                        </div>
                                        ` : ''}
                                        ${g.analiseTecnica ? `
                                        <div class="bg-black/20 p-3 rounded-lg">
                                            <div class="text-[10px] font-bold text-slate-500 uppercase mb-1"><i class="fas fa-microscope mr-1"></i>Analise Tecnica</div>
                                            <p class="text-xs text-slate-400 leading-relaxed">${g.analiseTecnica}</p>
                                        </div>
                                        ` : ''}
                                        ${g.h2h ? `
                                        <div class="bg-black/20 p-3 rounded-lg">
                                            <div class="text-[10px] font-bold text-slate-500 uppercase mb-1"><i class="fas fa-exchange-alt mr-1"></i>Confronto Direto (H2H)</div>
                                            <p class="text-xs text-slate-400 leading-relaxed">${g.h2h}</p>
                                        </div>
                                        ` : ''}
                                        <div class="bg-black/20 p-3 rounded-lg">
                                            <p class="text-xs text-slate-300 leading-relaxed"><i class="fas fa-microchip text-app-ai mr-1"></i>${g.analysis}</p>
                                        </div>
                                        ${g.confianca ? `
                                        <div class="flex items-center justify-between gap-3 px-1">
                                            <span class="text-[10px] text-slate-500">Confianca</span>
                                            <div class="w-32">${renderConfianca(g.confianca)}</div>
                                        </div>
                                        ` : ''}
                                        ${g.fontesUsadas ? `
                                        <div class="px-1">
                                            <div class="text-[10px] text-slate-600"><i class="fas fa-link mr-1"></i>Fontes: ${g.fontesUsadas}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                `;
            },
            Palpites: () => {
                const data = Store.getAppData();
                const isSubmitted = data.submitted;
                const voteCount = Object.keys(data.votes).length;
                const progress = Math.round((voteCount / 14) * 100);
                
                // Classificação de percentual estilo Vovoteca
                const getPercClass = (perc) => {
                    if (perc >= 81) return 'bg-blue-600 text-white'; // Super favorito
                    if (perc >= 51) return 'bg-blue-400 text-white'; // Favorito
                    if (perc >= 26) return 'bg-green-500 text-white'; // Normal
                    if (perc >= 13) return 'bg-yellow-500 text-black'; // Surpresa
                    return 'bg-red-500 text-white'; // Zebra
                };
                const getPercLabel = (perc) => {
                    if (perc >= 81) return 'S.F.';
                    if (perc >= 51) return 'FAV';
                    if (perc >= 26) return 'N';
                    if (perc >= 13) return 'SUR';
                    return 'ZEB';
                };
                
                return '<div class="animate-fade-in pb-20">' +
                    '<div class="bg-gradient-to-br from-app-surface to-app-bg p-6 rounded-2xl border border-app-primary/20 shadow-2xl mb-6">' +
                        '<h2 class="text-2xl font-black text-white mb-2"><i class="fas fa-pen-to-square text-app-primary mr-2"></i>Palpites - Concurso #' + Data.analysis.current.id + '</h2>' +
                        '<p class="text-sm text-slate-300 mb-4">Preencha os 14 jogos e compare com a comunidade!</p>' +
                        '<div class="flex gap-3">' +
                            '<button onclick="Router.navigate(\'ranking\')" class="flex-1 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg py-3 text-xs font-bold text-white transition-all flex items-center justify-center gap-2"><i class="fas fa-trophy"></i> RANKING</button>' +
                            '<button onclick="Router.navigate(\'montador\')" class="flex-1 bg-amber-500/20 hover:bg-amber-500/30 border border-amber-500/30 rounded-lg py-3 text-xs font-bold text-amber-400 transition-all flex items-center justify-center gap-2"><i class="fas fa-gamepad"></i> MONTE SEU JOGO</button>' +
                        '</div>' +
                    '</div>' +
                    
                    // Progress bar ou status de envio
                    (!isSubmitted ? 
                        '<div class="bg-app-surface p-4 rounded-xl border border-white/5 mb-4 shadow-lg">' +
                            '<div class="flex justify-between text-xs text-slate-300 mb-1"><span>Progresso</span><span id="vote-progress-text" class="font-bold text-app-primary">' + voteCount + '/14</span></div>' +
                            '<div class="h-2 bg-black/40 rounded-full overflow-hidden"><div id="vote-progress-bar" class="h-full bg-gradient-to-r from-green-600 to-app-primary transition-all duration-500" style="width: ' + progress + '%"></div></div>' +
                        '</div>'
                    : 
                        '<div class="bg-app-surface p-4 rounded-xl border border-white/5 mb-4 shadow-lg">' +
                            '<div class="flex items-center gap-3 border-l-4 border-app-primary pl-3">' +
                                '<div class="w-10 h-10 rounded-full bg-app-primary/20 flex items-center justify-center text-app-primary"><i class="fas fa-check text-xl"></i></div>' +
                                '<div class="flex-1"><h3 class="text-sm font-bold text-white">Palpites Enviados!</h3><p class="text-[10px] text-slate-300">Compare seus palpites com a comunidade abaixo.</p></div>' +
                                '<button onclick="Actions.resetVotes()" class="text-[10px] text-slate-500 underline">Refazer</button>' +
                            '</div>' +
                            // Legenda de cores
                            '<div class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-white/5">' +
                                '<span class="text-[9px] text-slate-500">Legenda:</span>' +
                                '<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-red-500 text-white">ZEB 0-12%</span>' +
                                '<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-yellow-500 text-black">SUR 13-25%</span>' +
                                '<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-green-500 text-white">N 26-50%</span>' +
                                '<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-blue-400 text-white">FAV 51-80%</span>' +
                                '<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-blue-600 text-white">S.F. 81%+</span>' +
                            '</div>' +
                        '</div>'
                    ) +
                    
                    // Grid de jogos
                    '<div class="bg-app-surface rounded-xl border border-white/5 overflow-hidden shadow-xl">' +
                        // Header da tabela (quando submitted)
                        (isSubmitted ? '<div class="grid grid-cols-12 gap-1 px-3 py-2 bg-black/30 border-b border-white/10"><div class="col-span-1 text-center text-[9px] font-bold text-slate-500">JG</div><div class="col-span-3 text-right text-[9px] font-bold text-slate-500">MANDANTE</div><div class="col-span-1 text-center text-[9px] font-bold text-green-400">1</div><div class="col-span-1 text-center text-[9px] font-bold text-yellow-400">X</div><div class="col-span-1 text-center text-[9px] font-bold text-red-400">2</div><div class="col-span-3 text-left text-[9px] font-bold text-slate-500">VISITANTE</div><div class="col-span-2 text-center text-[9px] font-bold text-slate-500">SEU</div></div>' : '') +
                        
                        Data.games.map(g => {
                            const vote = data.votes[g.id];
                            if (!isSubmitted) {
                                const renderCell = (type, label) => {
                                    const isSel = vote === type;
                                    let cls = isSel ? 'bg-blue-500 text-white font-bold' : 'bg-slate-800 text-slate-400';
                                    return '<button data-vote-type="' + type + '" onclick="Actions.vote(' + g.id + ', \'' + type + '\')" class="h-9 w-full rounded flex items-center justify-center text-xs transition-all ' + cls + ' hover:scale-105">' + (isSel?'<i class="fas fa-check"></i>':label) + '</button>';
                                };
                                return '<div data-game-id="' + g.id + '" class="grid grid-cols-12 gap-2 border-b border-white/5 items-center py-3 px-3"><div class="col-span-1 text-center text-xs font-bold text-slate-500">' + g.id + '</div><div class="col-span-4 text-right text-xs font-bold text-white truncate pr-2">' + g.home.name + '</div><div class="col-span-1">' + renderCell('h','1') + '</div><div class="col-span-1">' + renderCell('d','X') + '</div><div class="col-span-1">' + renderCell('a','2') + '</div><div class="col-span-4 text-left text-xs font-bold text-white truncate pl-2">' + g.away.name + '</div></div>';
                            } else {
                                // Modo enquete - mostrar percentuais coloridos
                                const total = g.comm.h + g.comm.d + g.comm.a;
                                const percH = total > 0 ? Math.round((g.comm.h / total) * 100) : 33;
                                const percD = total > 0 ? Math.round((g.comm.d / total) * 100) : 34;
                                const percA = total > 0 ? 100 - percH - percD : 33;
                                
                                const voteLabel = vote === 'h' ? '1' : (vote === 'd' ? 'X' : '2');
                                const voteColor = vote === 'h' ? 'text-green-400' : (vote === 'd' ? 'text-yellow-400' : 'text-red-400');
                                
                                // Verificar se o palpite do usuário é o favorito
                                const maxPerc = Math.max(percH, percD, percA);
                                const userPerc = vote === 'h' ? percH : (vote === 'd' ? percD : percA);
                                const isContrarian = userPerc < 26; // Palpite contra a maioria
                                
                                return '<div class="grid grid-cols-12 gap-1 border-b border-white/5 items-center py-2.5 px-3 ' + (isContrarian ? 'bg-red-500/5' : '') + '">' +
                                    '<div class="col-span-1 text-center text-[10px] font-bold text-slate-500">' + g.id + '</div>' +
                                    '<div class="col-span-3 text-right text-[10px] font-bold text-white truncate pr-1">' + g.home.name + '</div>' +
                                    '<div class="col-span-1 text-center"><span class="inline-block w-full px-0.5 py-1 rounded text-[10px] font-black ' + getPercClass(percH) + '">' + percH + '%</span></div>' +
                                    '<div class="col-span-1 text-center"><span class="inline-block w-full px-0.5 py-1 rounded text-[10px] font-black ' + getPercClass(percD) + '">' + percD + '%</span></div>' +
                                    '<div class="col-span-1 text-center"><span class="inline-block w-full px-0.5 py-1 rounded text-[10px] font-black ' + getPercClass(percA) + '">' + percA + '%</span></div>' +
                                    '<div class="col-span-3 text-left text-[10px] font-bold text-white truncate pl-1">' + g.away.name + '</div>' +
                                    '<div class="col-span-2 text-center"><span class="text-sm font-black ' + voteColor + '">' + voteLabel + '</span>' + (isContrarian ? '<i class="fas fa-bolt text-amber-400 text-[8px] ml-0.5" title="Palpite ousado!"></i>' : '') + '</div>' +
                                '</div>';
                            }
                        }).join('') +
                    '</div>' +
                    
                    // Resumo da comparação (quando submitted)
                    (isSubmitted ? '<div class="bg-app-surface p-4 rounded-xl border border-white/5 mt-4">' +
                        '<h4 class="text-xs font-bold text-slate-400 mb-3"><i class="fas fa-chart-bar mr-1"></i>Resumo da sua aposta vs Comunidade</h4>' +
                        '<div class="grid grid-cols-3 gap-3">' +
                            (() => {
                                let comMaioria = 0, contraMaioria = 0, neutro = 0;
                                Data.games.forEach(g => {
                                    const v = data.votes[g.id];
                                    const total = g.comm.h + g.comm.d + g.comm.a;
                                    const percH = total > 0 ? Math.round((g.comm.h / total) * 100) : 33;
                                    const percD = total > 0 ? Math.round((g.comm.d / total) * 100) : 34;
                                    const percA = total > 0 ? 100 - percH - percD : 33;
                                    const userPerc = v === 'h' ? percH : (v === 'd' ? percD : percA);
                                    if (userPerc >= 51) comMaioria++;
                                    else if (userPerc < 26) contraMaioria++;
                                    else neutro++;
                                });
                                return '<div class="bg-green-500/10 p-3 rounded-lg text-center"><div class="text-2xl font-black text-green-400">' + comMaioria + '</div><div class="text-[9px] text-slate-400">Com a maioria</div></div>' +
                                    '<div class="bg-yellow-500/10 p-3 rounded-lg text-center"><div class="text-2xl font-black text-yellow-400">' + neutro + '</div><div class="text-[9px] text-slate-400">Equilibrado</div></div>' +
                                    '<div class="bg-red-500/10 p-3 rounded-lg text-center"><div class="text-2xl font-black text-red-400">' + contraMaioria + '</div><div class="text-[9px] text-slate-400">Contra a maioria</div></div>';
                            })() +
                        '</div>' +
                        '<p class="text-[10px] text-slate-500 mt-3 text-center">Total de votos da comunidade: ' + Data.games.reduce((sum, g) => sum + g.comm.h + g.comm.d + g.comm.a, 0) + '</p>' +
                    '</div>' : '') +
                    
                    // Botão enviar
                    (!isSubmitted ? '<div class="mt-6"><button onclick="Actions.submitVotes()" class="w-full bg-app-primary text-black font-bold py-4 rounded-xl shadow-xl text-sm">ENVIAR PALPITES</button></div>' : '') +
                '</div>';
            },
                        AiXray: () => {
                const rc = Data.analysis.current.resumoCartela;
                const palpites = rc && rc.palpites ? rc.palpites.split(',') : [];
                const duplos = rc && rc.duplos ? rc.duplos : [];
                const triplos = rc && rc.triplos ? rc.triplos : [];
                const estrategia = rc && rc.estrategia ? rc.estrategia : '';
                const jogosChave = rc && rc.jogosChave ? rc.jogosChave : [];
                
                const renderPalpiteBadge = (p) => {
                    const v = (p || '').trim();
                    if (v === '1') return '<span class="font-black text-green-400">1</span>';
                    if (v === 'X' || v === 'x') return '<span class="font-black text-yellow-400">X</span>';
                    if (v === '2') return '<span class="font-black text-red-400">2</span>';
                    return '<span class="text-slate-500">-</span>';
                };

                // Calcular custo
                let numApostas = 1;
                duplos.forEach(() => numApostas *= 2);
                triplos.forEach(() => numApostas *= 3);
                const custoBase = 2.00; // valor por aposta individual Loteca
                const custoTotal = (numApostas * custoBase).toFixed(2);

                return `
                <div class="animate-fade-in space-y-6">
                    <button onclick="Router.navigate('home')" class="text-xs text-slate-400 hover:text-white flex items-center gap-2 mb-4">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    
                    <div class="bg-gradient-to-br from-violet-900/30 to-app-bg p-6 rounded-2xl border border-app-ai/30 shadow-2xl">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 rounded-xl bg-app-ai/20 flex items-center justify-center">
                                <i class="fas fa-microchip text-app-ai text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-black text-white">Raio X IA</h2>
                                <p class="text-[10px] text-slate-400">Concurso #${Data.analysis.current.id} - Analise Premium</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-300 leading-relaxed">${Data.analysis.current.fullAnalysis}</p>
                    </div>

                    ${palpites.length > 0 ? `
                    <div class="bg-app-surface p-6 rounded-2xl border border-app-primary/20">
                        <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-list-ol text-app-primary mr-2"></i>Cartela Recomendada</h3>
                        <div class="bg-black/20 rounded-xl overflow-hidden">
                            ${Data.games.map((g, idx) => {
                                const palpite = palpites[idx] || '-';
                                const isDuplo = duplos.find(d => d.jogo === g.id);
                                const isTriplo = triplos.find(t => t.jogo === g.id);
                                const isChave = jogosChave.includes(g.id);
                                let badge = '';
                                if (isTriplo) badge = '<span class="text-[9px] font-bold text-red-400 bg-red-500/20 px-1.5 py-0.5 rounded">TRIPLO</span>';
                                else if (isDuplo) badge = '<span class="text-[9px] font-bold text-yellow-400 bg-yellow-500/20 px-1.5 py-0.5 rounded">DUPLO ' + isDuplo.opcoes + '</span>';
                                return `
                                <div class="flex items-center justify-between px-4 py-2.5 border-b border-white/5 ${isChave ? 'bg-app-ai/5' : ''}">
                                    <div class="flex items-center gap-3 flex-1">
                                        <span class="text-[10px] font-bold text-slate-600 w-5">${g.id}</span>
                                        <span class="text-xs text-white truncate">${g.home.short} x ${g.away.short}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${badge}
                                        ${isChave ? '<i class="fas fa-star text-[10px] text-app-ai"></i>' : ''}
                                        <div class="w-8 text-center text-sm">${renderPalpiteBadge(palpite)}</div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${duplos.length > 0 || triplos.length > 0 ? `
                    <div class="bg-app-surface p-6 rounded-2xl border border-yellow-500/20">
                        <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-layer-group text-yellow-400 mr-2"></i>Duplos e Triplos</h3>
                        <div class="space-y-3">
                            ${duplos.map(d => `
                            <div class="bg-black/20 p-3 rounded-lg border-l-4 border-yellow-500">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs font-bold text-yellow-400">DUPLO - Jogo ${d.jogo} (${d.opcoes})</span>
                                    <span class="text-[10px] text-slate-500">${Data.games[d.jogo-1] ? Data.games[d.jogo-1].home.short + ' x ' + Data.games[d.jogo-1].away.short : ''}</span>
                                </div>
                                <p class="text-[10px] text-slate-400">${d.motivo}</p>
                            </div>
                            `).join('')}
                            ${triplos.map(t => `
                            <div class="bg-black/20 p-3 rounded-lg border-l-4 border-red-500">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs font-bold text-red-400">TRIPLO - Jogo ${t.jogo} (${t.opcoes})</span>
                                    <span class="text-[10px] text-slate-500">${Data.games[t.jogo-1] ? Data.games[t.jogo-1].home.short + ' x ' + Data.games[t.jogo-1].away.short : ''}</span>
                                </div>
                                <p class="text-[10px] text-slate-400">${t.motivo}</p>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${estrategia ? `
                    <div class="bg-app-surface p-6 rounded-2xl border border-app-primary/20">
                        <h3 class="text-lg font-bold text-white mb-3"><i class="fas fa-chess text-app-primary mr-2"></i>Estrategia de Aposta</h3>
                        <p class="text-sm text-slate-300 leading-relaxed mb-4">${estrategia}</p>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-black/20 p-3 rounded-lg text-center">
                                <div class="text-lg font-black text-app-primary">${numApostas}</div>
                                <div class="text-[10px] text-slate-500">Apostas</div>
                            </div>
                            <div class="bg-black/20 p-3 rounded-lg text-center">
                                <div class="text-lg font-black text-yellow-400">${duplos.length}D/${triplos.length}T</div>
                                <div class="text-[10px] text-slate-500">Duplos/Triplos</div>
                            </div>
                            <div class="bg-black/20 p-3 rounded-lg text-center">
                                <div class="text-lg font-black text-white">R$ ${custoTotal}</div>
                                <div class="text-[10px] text-slate-500">Custo Est.</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${jogosChave.length > 0 ? `
                    <div class="bg-app-surface p-6 rounded-2xl border border-app-ai/20">
                        <h3 class="text-lg font-bold text-white mb-3"><i class="fas fa-star text-app-ai mr-2"></i>Jogos-Chave da Rodada</h3>
                        <p class="text-[10px] text-slate-500 mb-3">Jogos que podem definir o resultado da cartela. Preste atencao especial nestes confrontos.</p>
                        <div class="space-y-2">
                            ${jogosChave.map(jId => {
                                const g = Data.games.find(game => game.id === jId);
                                if (!g) return '';
                                return `
                                <div class="bg-black/20 p-3 rounded-lg flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="text-app-ai"><i class="fas fa-star"></i></span>
                                        <span class="text-sm font-bold text-white">${g.home.name} x ${g.away.name}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${g.palpiteIA ? (g.palpiteIA === '1' ? '<span class="text-xs text-green-400 font-bold">COL 1</span>' : (g.palpiteIA === 'X' ? '<span class="text-xs text-yellow-400 font-bold">EMP</span>' : '<span class="text-xs text-red-400 font-bold">COL 2</span>')) : ''}
                                        ${g.riscoZebra ? '<span class="text-[10px] text-slate-500">Zebra: ' + g.riscoZebra + '</span>' : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="bg-app-surface p-6 rounded-2xl border border-violet-500/30 text-center">
                        <i class="fas fa-microchip text-app-ai text-3xl mb-3"></i>
                        <p class="text-sm text-slate-400">Analise premium sera gerada quando o concurso for publicado com a nova versao da IA.</p>
                        <p class="text-[10px] text-slate-500 mt-2">Use "Regenerar Analise IA" no painel admin para atualizar.</p>
                    </div>
                    `}
                </div>
                `;
            },

            Market: () => {
                const m = Data.mercado || { destaque: [], rumores: [], lesoes: [], impacto: '', fontes: [] };
                const isLoading = Data._mercadoLoading;
                const totalNoticias = (m.destaque?.length || 0) + (m.rumores?.length || 0) + (m.lesoes?.length || 0);
                const atualizadoEm = m.atualizadoEm || m.atualizadoEmISO || '';
                let dataFormatada = '';
                if (atualizadoEm) {
                    try {
                        const d = atualizadoEm.toDate ? atualizadoEm.toDate() : new Date(atualizadoEm);
                        dataFormatada = d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    } catch(e) { dataFormatada = ''; }
                }
                const isAdmin = Auth.user && Auth.user.email === 'mateusmachado11m@gmail.com';
                
                // Filtros
                const filtroTipo = State.mercadoFiltroTipo || 'todos';
                const filtroTime = State.mercadoFiltroTime || 'todos';
                
                // Extrair times únicos de todas as notícias
                const timesSet = new Set();
                (m.destaque || []).forEach(t => { if(t.de) timesSet.add(t.de); if(t.para) timesSet.add(t.para); });
                (m.rumores || []).forEach(r => { if(r.times) r.times.forEach(t => timesSet.add(t)); else if(r.descricao) { const match = r.descricao.match(/([A-Z][a-záéíóúãõ]+(?:\s[A-Z][a-záéíóúãõ]*)*)/g); if(match) match.forEach(t => timesSet.add(t)); }});
                (m.lesoes || []).forEach(l => { if(l.time) timesSet.add(l.time); });
                // Também extrair dos jogos do concurso
                Data.games.forEach(g => { timesSet.add(g.home.name); timesSet.add(g.away.name); });
                const timesArray = [...timesSet].sort();
                
                // Aplicar filtros
                let destaque = m.destaque || [];
                let rumores = m.rumores || [];
                let lesoes = m.lesoes || [];
                
                if (filtroTime !== 'todos') {
                    const ft = filtroTime.toLowerCase();
                    destaque = destaque.filter(t => (t.de||'').toLowerCase().includes(ft) || (t.para||'').toLowerCase().includes(ft));
                    rumores = rumores.filter(r => (r.descricao||'').toLowerCase().includes(ft) || (r.jogador||'').toLowerCase().includes(ft) || (r.times||[]).some(t => t.toLowerCase().includes(ft)));
                    lesoes = lesoes.filter(l => (l.time||'').toLowerCase().includes(ft));
                }
                
                const showTransf = filtroTipo === 'todos' || filtroTipo === 'transferencias';
                const showRumores = filtroTipo === 'todos' || filtroTipo === 'rumores';
                const showLesoes = filtroTipo === 'todos' || filtroTipo === 'lesoes';
                const showImpacto = filtroTipo === 'todos' || filtroTipo === 'impacto';
                
                const filtroBtn = (id, label, icon, count) => {
                    const isActive = filtroTipo === id;
                    return '<button onclick="State.mercadoFiltroTipo=\'' + id + '\'; Router.render();" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all ' + (isActive ? 'bg-app-primary text-black' : 'bg-white/5 text-slate-400 hover:bg-white/10') + '"><i class="fas ' + icon + '"></i>' + label + (count > 0 ? ' <span class="px-1.5 py-0.5 rounded-full text-[9px] ' + (isActive ? 'bg-black/20' : 'bg-white/10') + '">' + count + '</span>' : '') + '</button>';
                };
                
                return '<div class="animate-fade-in space-y-4">' +
                    // Header
                    '<div class="bg-gradient-to-br from-app-surface to-app-bg p-6 rounded-2xl border border-app-primary/20 shadow-2xl">' +
                        '<div class="flex items-center justify-between mb-2">' +
                            '<h2 class="text-2xl font-black text-white"><i class="fas fa-exchange-alt text-app-primary mr-2"></i>Mercado da Bola</h2>' +
                            (isAdmin ? '<button onclick="MercadoActions.atualizar(true)" class="px-3 py-1.5 bg-app-primary/20 hover:bg-app-primary/30 text-app-primary text-xs font-bold rounded-lg transition-all" id="btn-atualizar-mercado"><i class="fas fa-sync-alt mr-1"></i>Atualizar</button>' : '') +
                        '</div>' +
                        '<p class="text-sm text-slate-300">Transferencias, rumores e lesoes que impactam a Loteca</p>' +
                        (dataFormatada ? '<div class="flex flex-wrap items-center gap-3 mt-3"><span class="text-xs text-slate-500"><i class="fas fa-clock mr-1"></i>Atualizado: ' + dataFormatada + '</span><span class="text-xs text-slate-500"><i class="fas fa-newspaper mr-1"></i>' + totalNoticias + ' noticias</span></div>' : '') +
                    '</div>' +
                    
                    // Filtros por tipo
                    (!isLoading ? '<div class="bg-app-surface p-4 rounded-xl border border-white/5">' +
                        '<div class="flex items-center gap-2 mb-3"><i class="fas fa-filter text-slate-400 text-xs"></i><span class="text-xs font-bold text-slate-400">Filtrar por tipo</span></div>' +
                        '<div class="flex flex-wrap gap-2">' +
                            filtroBtn('todos', 'Todos', 'fa-globe', totalNoticias) +
                            filtroBtn('transferencias', 'Transferencias', 'fa-check-circle', destaque.length) +
                            filtroBtn('rumores', 'Rumores', 'fa-comment-dots', rumores.length) +
                            filtroBtn('lesoes', 'Lesoes', 'fa-medkit', lesoes.length) +
                            filtroBtn('impacto', 'Impacto', 'fa-lightbulb', 0) +
                        '</div>' +
                        // Filtro por time
                        '<div class="mt-4">' +
                            '<button onclick="var el=document.getElementById(\'filtro-times-dropdown\'); el.classList.toggle(\'hidden\'); var icon=document.getElementById(\'filtro-times-icon\'); icon.classList.toggle(\'fa-chevron-down\'); icon.classList.toggle(\'fa-chevron-up\');" class="flex items-center justify-between w-full px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg transition-all">' +
                                '<span class="flex items-center gap-2"><i class="fas fa-shield-alt text-slate-400 text-xs"></i><span class="text-xs font-bold text-slate-400">Filtrar por time</span>' + (filtroTime !== 'todos' ? '<span class="px-2 py-0.5 bg-app-primary/20 text-app-primary text-[10px] font-bold rounded-full ml-1">' + filtroTime + '</span>' : '') + '</span>' +
                                '<i id="filtro-times-icon" class="fas fa-chevron-down text-slate-500 text-xs"></i>' +
                            '</button>' +
                            '<div id="filtro-times-dropdown" class="hidden mt-2 p-3 bg-black/20 rounded-lg border border-white/5">' +
                                '<div class="flex flex-wrap gap-1.5">' +
                                    '<button onclick="State.mercadoFiltroTime=\'todos\'; Router.render();" class="px-2.5 py-1 rounded-full text-[10px] font-bold transition-all ' + (filtroTime === 'todos' ? 'bg-app-primary text-black' : 'bg-white/5 text-slate-400 hover:bg-white/10') + '">Todos</button>' +
                                    timesArray.map(t => '<button onclick="State.mercadoFiltroTime=\'' + t.replace(/'/g, "\\'") + '\'; Router.render();" class="px-2.5 py-1 rounded-full text-[10px] font-bold transition-all ' + (filtroTime === t ? 'bg-app-primary text-black' : 'bg-white/5 text-slate-400 hover:bg-white/10') + '">' + t + '</button>').join('') +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' : '') +
                    
                    // Loading
                    (isLoading ? '<div class="bg-app-surface p-12 rounded-xl border border-app-primary/20 text-center"><div class="animate-spin w-12 h-12 border-4 border-app-primary/30 border-t-app-primary rounded-full mx-auto mb-4"></div><p class="text-white font-bold">Buscando noticias nos portais esportivos...</p><p class="text-xs text-slate-400 mt-2">Consultando ge.globo, Gazzetta, Marca, BBC Sport e outros</p></div>' : '') +
                    
                    // Transferências
                    (!isLoading && showTransf ? '<div class="bg-app-surface p-6 rounded-xl border border-green-500/20"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold"><i class="fas fa-check-circle text-green-400 mr-2"></i>Transferencias Confirmadas</h3>' + (destaque.length > 0 ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-[10px] font-bold rounded">' + destaque.length + '</span>' : '') + '</div>' + (destaque.length > 0 ? destaque.map(t => '<div class="flex items-start gap-4 bg-black/20 p-4 rounded-lg mb-3 border border-white/5"><div class="w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-1"><i class="fas fa-user-plus text-green-400"></i></div><div class="flex-1"><div class="text-white font-bold text-sm">' + t.jogador + '</div><div class="text-xs text-slate-400 mt-1">' + t.de + ' <i class="fas fa-arrow-right text-app-primary mx-1"></i> ' + t.para + '</div>' + (t.impactoLoteca ? '<div class="text-xs text-violet-400 mt-1"><i class="fas fa-futbol mr-1"></i>' + t.impactoLoteca + '</div>' : '') + '<div class="flex items-center gap-3 mt-1">' + (t.data ? '<span class="text-xs text-slate-500"><i class="fas fa-calendar mr-1"></i>' + t.data + '</span>' : '') + (t.fonte ? '<span class="text-xs text-slate-500"><i class="fas fa-newspaper mr-1"></i>' + t.fonte + '</span>' : '') + '</div></div>' + (t.valor ? '<div class="text-app-primary font-bold text-sm whitespace-nowrap">' + t.valor + '</div>' : '') + '</div>').join('') : '<div class="text-center py-6"><i class="fas fa-newspaper text-3xl text-slate-700 mb-2"></i><p class="text-sm text-slate-500">Nenhuma transferencia encontrada' + (filtroTime !== 'todos' ? ' para ' + filtroTime : '') + '.</p></div>') + '</div>' : '') +
                    
                    // Rumores
                    (!isLoading && showRumores ? '<div class="bg-app-surface p-6 rounded-xl border border-yellow-500/20"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold"><i class="fas fa-comment-dots text-yellow-400 mr-2"></i>Rumores e Negociacoes</h3>' + (rumores.length > 0 ? '<span class="px-2 py-0.5 bg-yellow-500/20 text-yellow-400 text-[10px] font-bold rounded">' + rumores.length + '</span>' : '') + '</div>' + (rumores.length > 0 ? rumores.map(r => '<div class="flex items-start gap-4 bg-black/20 p-4 rounded-lg mb-3 border border-white/5"><div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-1"><i class="fas fa-question text-yellow-400"></i></div><div class="flex-1"><div class="text-white font-bold text-sm">' + r.jogador + '</div><div class="text-xs text-slate-400 mt-1">' + r.descricao + '</div>' + (r.impactoLoteca ? '<div class="text-xs text-violet-400 mt-1"><i class="fas fa-futbol mr-1"></i>' + r.impactoLoteca + '</div>' : '') + (r.fonte ? '<div class="text-xs text-slate-500 mt-1"><i class="fas fa-newspaper mr-1"></i>' + r.fonte + '</div>' : '') + '</div><span class="px-2 py-1 rounded text-[10px] font-bold ' + (r.probabilidade === 'alta' ? 'bg-green-500/20 text-green-400' : (r.probabilidade === 'media' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400')) + '">' + (r.probabilidade || 'media').toUpperCase() + '</span></div>').join('') : '<div class="text-center py-6"><i class="fas fa-comment-slash text-3xl text-slate-700 mb-2"></i><p class="text-sm text-slate-500">Nenhum rumor encontrado' + (filtroTime !== 'todos' ? ' para ' + filtroTime : '') + '.</p></div>') + '</div>' : '') +
                    
                    // Lesões
                    (!isLoading && showLesoes ? '<div class="bg-app-surface p-6 rounded-xl border border-red-500/20"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold"><i class="fas fa-medkit text-red-400 mr-2"></i>Lesoes e Desfalques</h3>' + (lesoes.length > 0 ? '<span class="px-2 py-0.5 bg-red-500/20 text-red-400 text-[10px] font-bold rounded">' + lesoes.length + '</span>' : '') + '</div>' + (lesoes.length > 0 ? lesoes.map(l => '<div class="flex items-start gap-4 bg-black/20 p-4 rounded-lg mb-3 border border-white/5"><div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-1"><i class="fas fa-heartbeat text-red-400"></i></div><div class="flex-1"><div class="text-white font-bold text-sm">' + l.jogador + ' <span class="text-xs text-slate-400 font-normal">(' + l.time + ')</span></div><div class="text-xs text-slate-400 mt-1">' + l.descricao + '</div>' + (l.impactoLoteca ? '<div class="text-xs text-violet-400 mt-1"><i class="fas fa-futbol mr-1"></i>' + l.impactoLoteca + '</div>' : '') + '<div class="text-xs text-slate-500 mt-1"><i class="fas fa-clock mr-1"></i>Previsao: ' + (l.previsao || 'Indefinida') + '</div></div><span class="px-2 py-1 rounded text-[10px] font-bold ' + (l.gravidade === 'alta' ? 'bg-red-500/20 text-red-400' : (l.gravidade === 'media' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400')) + '">' + (l.gravidade || 'media').toUpperCase() + '</span></div>').join('') : '<div class="text-center py-6"><i class="fas fa-notes-medical text-3xl text-slate-700 mb-2"></i><p class="text-sm text-slate-500">Nenhuma lesao encontrada' + (filtroTime !== 'todos' ? ' para ' + filtroTime : '') + '.</p></div>') + '</div>' : '') +
                    
                    // Impacto
                    (!isLoading && showImpacto ? '<div class="bg-app-surface p-6 rounded-xl border border-violet-500/20"><h3 class="text-white font-bold mb-4"><i class="fas fa-lightbulb text-violet-400 mr-2"></i>Impacto na Loteca</h3><div class="text-sm text-slate-300 leading-relaxed whitespace-pre-line">' + (m.impacto || 'Publique um concurso para gerar a analise de impacto.') + '</div></div>' : '') +
                    
                    // Fontes
                    (!isLoading && m.fontes && m.fontes.length > 0 ? '<div class="bg-app-surface p-4 rounded-xl border border-white/5"><h4 class="text-xs font-bold text-slate-400 mb-3"><i class="fas fa-link mr-1"></i>Fontes consultadas (' + m.fontes.length + ')</h4><div class="flex flex-wrap gap-2">' + m.fontes.map(f => '<a href="' + f.url + '" target="_blank" rel="noopener" class="text-[10px] px-2 py-1 bg-black/30 text-slate-400 hover:text-app-primary rounded border border-white/5 transition-colors truncate max-w-[200px]" title="' + f.titulo + '">' + (f.titulo || f.url) + '</a>').join('') + '</div></div>' : '') +
                '</div>';
            },
            
            MontadorContent: () => {
                const montagem = State.montagem || {};
                const jogos = Data.games;
                let numDuplos = 0, numTriplos = 0;
                jogos.forEach(g => { const sel = montagem[g.id] || []; if (sel.length === 2) numDuplos++; if (sel.length === 3) numTriplos++; });
                let numApostas = 1;
                jogos.forEach(g => { const sel = montagem[g.id] || []; if (sel.length >= 1) numApostas *= sel.length; });
                const custoAposta = 2.00;
                const valorTotal = numApostas * custoAposta;
                const todosPreenchidos = jogos.every(g => (montagem[g.id] || []).length >= 1);
                return '<div id="montador-painel" class="bg-app-surface p-4 rounded-xl border border-amber-500/20 sticky top-0 z-10">' +
                    '<div class="flex items-center justify-between">' +
                        '<div class="flex items-center gap-4">' +
                            '<div class="text-center"><div class="text-lg font-black text-white">' + numDuplos + '</div><div class="text-[9px] text-slate-400">Duplos</div></div>' +
                            '<div class="text-center"><div class="text-lg font-black text-white">' + numTriplos + '</div><div class="text-[9px] text-slate-400">Triplos</div></div>' +
                            '<div class="text-center"><div class="text-lg font-black text-white">' + numApostas.toLocaleString('pt-BR') + '</div><div class="text-[9px] text-slate-400">Apostas</div></div>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<div class="text-2xl font-black text-app-primary">R$ ' + valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</div>' +
                            '<div class="text-[9px] text-slate-400">Valor total</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div id="montador-grid" class="bg-app-surface rounded-xl border border-white/5 overflow-hidden">' +
                    '<div class="grid grid-cols-12 gap-1 px-3 py-2 bg-black/30 border-b border-white/10">' +
                        '<div class="col-span-1 text-center text-[9px] font-bold text-slate-500">JG</div>' +
                        '<div class="col-span-4 text-right text-[9px] font-bold text-slate-500">MANDANTE</div>' +
                        '<div class="col-span-1 text-center text-[9px] font-bold text-blue-400">1</div>' +
                        '<div class="col-span-1 text-center text-[9px] font-bold text-blue-400">X</div>' +
                        '<div class="col-span-1 text-center text-[9px] font-bold text-blue-400">2</div>' +
                        '<div class="col-span-4 text-left text-[9px] font-bold text-slate-500">VISITANTE</div>' +
                    '</div>' +
                    jogos.map(g => {
                        const sel = montagem[g.id] || [];
                        const renderBtn = (type, label) => {
                            const isSel = sel.includes(type);
                            const cls = isSel ? 'bg-blue-500 text-white font-bold' : 'bg-slate-800 text-slate-400';
                            return '<button onclick="MontadorActions.toggle(' + g.id + ', \'' + type + '\')" class="h-9 w-full rounded flex items-center justify-center text-xs transition-all ' + cls + ' hover:scale-105">' + (isSel?'<i class="fas fa-check"></i>':label) + '</button>';
                        };
                        const tipo = sel.length === 3 ? '<span class="text-[8px] text-violet-400">T</span>' : (sel.length === 2 ? '<span class="text-[8px] text-amber-400">D</span>' : '');
                        return '<div class="grid grid-cols-12 gap-2 border-b border-white/5 items-center py-3 px-3">' +
                            '<div class="col-span-1 text-center text-xs font-bold text-slate-500">' + g.id + tipo + '</div>' +
                            '<div class="col-span-4 text-right text-xs font-bold text-white truncate pr-2">' + g.home.name + '</div>' +
                            '<div class="col-span-1">' + renderBtn('h','1') + '</div>' +
                            '<div class="col-span-1">' + renderBtn('d','X') + '</div>' +
                            '<div class="col-span-1">' + renderBtn('a','2') + '</div>' +
                            '<div class="col-span-4 text-left text-xs font-bold text-white truncate pl-2">' + g.away.name + '</div>' +
                        '</div>';
                    }).join('') +
                '</div>' +
                '<div id="montador-acoes" class="flex gap-3">' +
                    '<button onclick="MontadorActions.limpar()" class="flex-1 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-bold text-white transition-all"><i class="fas fa-eraser mr-1"></i>Limpar</button>' +
                    '<button onclick="MontadorActions.compartilhar()" class="flex-1 py-3 bg-app-primary hover:bg-green-400 text-black font-bold rounded-lg text-xs transition-all ' + (!todosPreenchidos ? 'opacity-50' : '') + '" ' + (!todosPreenchidos ? 'disabled' : '') + '><i class="fas fa-share-alt mr-1"></i>Compartilhar</button>' +
                    '<button onclick="MontadorActions.imprimir()" class="flex-1 py-3 bg-amber-500 hover:bg-amber-400 text-black font-bold rounded-lg text-xs transition-all ' + (!todosPreenchidos ? 'opacity-50' : '') + '" ' + (!todosPreenchidos ? 'disabled' : '') + '><i class="fas fa-print mr-1"></i>Imprimir</button>' +
                '</div>';
            },
            Montador: () => {
                return '<div class="animate-fade-in space-y-4 pb-20">' +
                    '<div class="bg-gradient-to-br from-amber-900/30 to-app-bg p-6 rounded-2xl border border-amber-500/20 shadow-2xl">' +
                        '<h2 class="text-2xl font-black text-white mb-2"><i class="fas fa-gamepad text-amber-400 mr-2"></i>Monte seu Jogo</h2>' +
                        '<p class="text-sm text-slate-300">Monte sua aposta, calcule o valor, imprima e compartilhe!</p>' +
                        '<p class="text-xs text-slate-500 mt-1">Concurso #' + Data.analysis.current.id + '</p>' +
                    '</div>' +
                    '<div id="montador-content" class="space-y-4">' + Views.MontadorContent() + '</div>' +
                '</div>';
            },
            
            CartolaContent: () => {
                const cd = Data._cartolaData || null;
                const isLoading = Data._cartolaLoading;
                const tab = Data._cartolaTab || 'parciais';
                const filtroTime = Data._cartolaFiltroTime || '';
                const filtroPosicao = Data._cartolaFiltroPosicao || '';
                
                if (isLoading) return '<div class="bg-app-surface p-12 rounded-xl border border-orange-500/20 text-center"><div class="animate-spin w-12 h-12 border-4 border-orange-500/30 border-t-orange-500 rounded-full mx-auto mb-4"></div><p class="text-white font-bold">Carregando parciais do Cartola...</p></div>';
                if (!cd) return '<div class="bg-app-surface p-8 rounded-xl border border-white/5 text-center"><i class="fas fa-futbol text-4xl text-slate-700 mb-3"></i><p class="text-sm text-slate-500">Clique em Atualizar para carregar as parciais do Cartola FC.</p></div>';
                
                // Tabs
                const tabs = [
                    {id:'parciais', icon:'fa-chart-line', label:'Parciais'},
                    {id:'jogadores', icon:'fa-users', label:'Jogadores'},
                    {id:'jogos', icon:'fa-futbol', label:'Jogos'},
                    {id:'meus-times', icon:'fa-star', label:'Meus Times'}
                ];
                let h = '<div class="flex gap-1 mb-4 overflow-x-auto pb-1">' +
                    tabs.map(t => '<button onclick="Data._cartolaTab=\'' + t.id + '\';CartolaActions._refresh()" class="flex-shrink-0 px-3 py-2 text-xs font-bold rounded-lg transition-all ' + (tab === t.id ? 'bg-orange-500 text-white' : 'bg-white/5 text-slate-400 hover:bg-white/10') + '"><i class="fas ' + t.icon + ' mr-1"></i>' + t.label + '</button>').join('') +
                '</div>';
                
                // === TAB PARCIAIS ===
                if (tab === 'parciais') {
                    h += '<div class="grid grid-cols-3 gap-3 mb-4">' +
                        '<div class="bg-black/20 p-3 rounded-lg text-center"><div class="text-lg font-black text-orange-400">' + (cd.rodada || '-') + '</div><div class="text-[9px] text-slate-400">Rodada</div></div>' +
                        '<div class="bg-black/20 p-3 rounded-lg text-center"><div class="text-lg font-black text-green-400">' + (cd.maiorPontuacao || '-') + '</div><div class="text-[9px] text-slate-400">Maior Pont.</div></div>' +
                        '<div class="bg-black/20 p-3 rounded-lg text-center"><div class="text-lg font-black text-amber-400">' + (cd.jogosFinalizados || '0') + '/' + (cd.totalJogos || '10') + '</div><div class="text-[9px] text-slate-400">Jogos</div></div>' +
                    '</div>' +
                    '<div class="bg-black/20 p-3 rounded-lg text-center mb-4"><span class="text-xs ' + (cd.status === 'Mercado Aberto' ? 'text-green-400' : (cd.status === 'Rodada em andamento' ? 'text-yellow-400' : 'text-slate-400')) + ' font-bold"><i class="fas fa-circle text-[6px] mr-1"></i>' + (cd.status || 'Indisponivel') + '</span><span class="text-xs text-slate-500 ml-3">' + (cd.timesEscalados ? cd.timesEscalados.toLocaleString('pt-BR') + ' times escalados' : '') + '</span></div>';
                    
                    // Top 10 destaques
                    if (cd.destaques && cd.destaques.length > 0) {
                        h += '<h4 class="text-xs font-bold text-slate-400 mb-2"><i class="fas fa-star text-orange-400 mr-1"></i>Top 10 Destaques</h4><div class="space-y-1">';
                        cd.destaques.forEach((j, i) => {
                            h += '<div class="flex items-center gap-2 bg-black/20 p-2 rounded-lg">' +
                                '<div class="w-6 h-6 rounded-full ' + (i < 3 ? 'bg-orange-500/30 text-orange-400' : 'bg-white/5 text-slate-500') + ' flex items-center justify-center font-bold text-[10px]">' + (i+1) + '</div>' +
                                (j.foto ? '<img src="' + j.foto + '" class="w-7 h-7 rounded-full object-cover bg-black/30">' : '') +
                                '<div class="flex-1 min-w-0"><div class="text-xs font-bold text-white truncate">' + j.nome + '</div><div class="text-[9px] text-slate-500">' + j.posicao + ' - ' + j.clube + '</div></div>' +
                                '<div class="text-right"><div class="text-sm font-black ' + (j.pontos >= 0 ? 'text-green-400' : 'text-red-400') + '">' + j.pontos + '</div></div>' +
                            '</div>';
                        });
                        h += '</div>';
                    } else {
                        h += '<div class="bg-black/20 p-6 rounded-lg text-center"><p class="text-xs text-slate-500">Nenhum jogador pontuado ainda nesta rodada.</p><p class="text-[10px] text-slate-600 mt-1">Os dados aparecem quando a bola rolar.</p></div>';
                    }
                }
                
                // === TAB JOGADORES ===
                if (tab === 'jogadores') {
                    const allJogadores = cd.todosJogadores || [];
                    const clubes = cd.clubesMap || {};
                    const clubesList = Object.values(clubes).sort((a,b) => a.nome > b.nome ? 1 : -1);
                    const posicoesList = ['GOL','LAT','ZAG','MEI','ATA','TEC'];
                    
                    // Filtros
                    h += '<div class="flex gap-2 mb-3 flex-wrap">';
                    // Dropdown time
                    h += '<div class="relative"><button onclick="document.getElementById(\'cartola-time-dd\').classList.toggle(\'hidden\')" class="px-3 py-1.5 bg-white/5 text-xs rounded-lg text-slate-300 hover:bg-white/10 flex items-center gap-1"><i class="fas fa-shield-alt"></i>' + (filtroTime ? clubes[filtroTime]?.abreviacao || filtroTime : 'Todos os times') + '<i class="fas fa-chevron-down text-[8px] ml-1"></i></button>' +
                        '<div id="cartola-time-dd" class="hidden absolute z-50 mt-1 bg-gray-800 border border-white/10 rounded-lg shadow-xl max-h-60 overflow-y-auto w-48">' +
                        '<button onclick="Data._cartolaFiltroTime=\'\';document.getElementById(\'cartola-time-dd\').classList.add(\'hidden\');CartolaActions._refresh()" class="w-full text-left px-3 py-2 text-xs text-slate-300 hover:bg-white/10">Todos os times</button>' +
                        clubesList.map(c => '<button onclick="Data._cartolaFiltroTime=\'' + c.id + '\';document.getElementById(\'cartola-time-dd\').classList.add(\'hidden\');CartolaActions._refresh()" class="w-full text-left px-3 py-2 text-xs text-slate-300 hover:bg-white/10 flex items-center gap-2">' + (c.escudo ? '<img src="' + c.escudo + '" class="w-4 h-4">' : '') + c.nome_fantasia + '</button>').join('') +
                        '</div></div>';
                    // Filtro posição
                    h += '<button onclick="Data._cartolaFiltroPosicao=\'\';CartolaActions._refresh()" class="px-2 py-1.5 text-[10px] rounded-lg font-bold ' + (!filtroPosicao ? 'bg-orange-500 text-white' : 'bg-white/5 text-slate-400 hover:bg-white/10') + '">Todos</button>';
                    posicoesList.forEach(p => {
                        h += '<button onclick="Data._cartolaFiltroPosicao=\'' + p + '\';CartolaActions._refresh()" class="px-2 py-1.5 text-[10px] rounded-lg font-bold ' + (filtroPosicao === p ? 'bg-orange-500 text-white' : 'bg-white/5 text-slate-400 hover:bg-white/10') + '">' + p + '</button>';
                    });
                    h += '</div>';
                    
                    // Filtrar jogadores
                    let filtered = allJogadores;
                    if (filtroTime) filtered = filtered.filter(j => String(j.clube_id) === String(filtroTime));
                    if (filtroPosicao) filtered = filtered.filter(j => j.posicao_abrev === filtroPosicao);
                    
                    h += '<div class="text-[10px] text-slate-500 mb-2">' + filtered.length + ' jogadores</div>';
                    
                    // Tabela
                    h += '<div class="space-y-1 max-h-[60vh] overflow-y-auto">';
                    if (filtered.length === 0) {
                        h += '<div class="bg-black/20 p-6 rounded-lg text-center text-xs text-slate-500">Nenhum jogador pontuado' + (filtroTime || filtroPosicao ? ' com esses filtros' : ' nesta rodada') + '.</div>';
                    } else {
                        // Header
                        h += '<div class="flex items-center gap-2 px-2 py-1 text-[9px] text-slate-600 font-bold"><div class="w-5">#</div><div class="flex-1">Jogador</div><div class="w-12 text-center">SG</div><div class="w-12 text-center">G</div><div class="w-12 text-center">A</div><div class="w-14 text-right">Pts</div></div>';
                        filtered.slice(0, 100).forEach((j, i) => {
                            const scouts = j.scout || {};
                            h += '<div class="flex items-center gap-2 bg-black/20 p-2 rounded-lg">' +
                                '<div class="w-5 text-[9px] text-slate-600 font-bold">' + (i+1) + '</div>' +
                                (j.foto ? '<img src="' + j.foto + '" class="w-6 h-6 rounded-full object-cover bg-black/30">' : '<div class="w-6 h-6 rounded-full bg-white/5"></div>') +
                                '<div class="flex-1 min-w-0"><div class="text-[11px] font-bold text-white truncate">' + j.nome + '</div><div class="text-[9px] text-slate-500">' + j.posicao + ' - ' + j.clube + '</div></div>' +
                                '<div class="w-12 text-center text-[10px] ' + ((scouts.SG || 0) > 0 ? 'text-green-400' : 'text-slate-600') + '">' + (scouts.SG || '-') + '</div>' +
                                '<div class="w-12 text-center text-[10px] ' + ((scouts.G || 0) > 0 ? 'text-green-400' : 'text-slate-600') + '">' + (scouts.G || '-') + '</div>' +
                                '<div class="w-12 text-center text-[10px] ' + ((scouts.A || 0) > 0 ? 'text-green-400' : 'text-slate-600') + '">' + (scouts.A || '-') + '</div>' +
                                '<div class="w-14 text-right"><span class="text-sm font-black ' + (j.pontos >= 0 ? 'text-green-400' : 'text-red-400') + '">' + j.pontos + '</span></div>' +
                            '</div>';
                        });
                    }
                    h += '</div>';
                }
                
                // === TAB JOGOS ===
                if (tab === 'jogos') {
                    const jogos = cd.jogos || [];
                    if (jogos.length === 0) {
                        h += '<div class="bg-black/20 p-6 rounded-lg text-center text-xs text-slate-500">Nenhum jogo encontrado.</div>';
                    } else {
                        h += '<div class="space-y-2">';
                        jogos.forEach(j => {
                            const statusClass = j.status === 'Encerrado' ? 'bg-green-500/20 text-green-400' : (j.status === 'Em andamento' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-white/5 text-slate-500');
                            h += '<div class="bg-black/20 p-3 rounded-lg">' +
                                '<div class="flex items-center gap-2">' +
                                    (j.escudoMandante ? '<img src="' + j.escudoMandante + '" class="w-6 h-6">' : '') +
                                    '<div class="flex-1 text-right text-xs font-bold text-white">' + j.mandante + '</div>' +
                                    '<div class="px-3 py-1 rounded bg-black/40 text-sm font-black ' + (j.status === 'Encerrado' ? 'text-white' : 'text-slate-400') + '">' + (j.placarMandante !== null && j.placarMandante !== undefined ? j.placarMandante + ' x ' + j.placarVisitante : 'vs') + '</div>' +
                                    '<div class="flex-1 text-left text-xs font-bold text-white">' + j.visitante + '</div>' +
                                    (j.escudoVisitante ? '<img src="' + j.escudoVisitante + '" class="w-6 h-6">' : '') +
                                '</div>' +
                                '<div class="flex justify-between mt-2"><span class="text-[9px] text-slate-600">' + (j.local || '') + '</span><span class="text-[9px] px-2 py-0.5 rounded ' + statusClass + '">' + (j.status || 'Agendado') + (j.horario ? ' - ' + j.horario : '') + '</span></div>' +
                            '</div>';
                        });
                        h += '</div>';
                    }
                }
                
                // === TAB MEUS TIMES ===
                if (tab === 'meus-times') {
                    const meusTimesIds = JSON.parse(localStorage.getItem('cartola_meus_times') || '[]');
                    const meusTimesData = Data._cartolaMeusTimes || {};
                    
                    // Input para adicionar time
                    h += '<div class="bg-black/20 p-3 rounded-lg mb-4">' +
                        '<p class="text-xs text-slate-400 mb-2"><i class="fas fa-plus-circle text-orange-400 mr-1"></i>Adicionar time pelo nome (slug do Cartola)</p>' +
                        '<div class="flex gap-2">' +
                            '<input id="cartola-add-time" type="text" placeholder="Ex: nome-do-time" class="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white placeholder-slate-600 focus:border-orange-500 focus:outline-none">' +
                            '<button onclick="CartolaActions.adicionarTime()" class="px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 text-xs font-bold rounded-lg"><i class="fas fa-search mr-1"></i>Buscar</button>' +
                        '</div>' +
                        '<p class="text-[9px] text-slate-600 mt-1">O slug é o nome do time na URL do Cartola (sem espaços, com hifens)</p>' +
                    '</div>';
                    
                    if (Data._cartolaTimeLoading) {
                        h += '<div class="bg-black/20 p-4 rounded-lg text-center"><div class="animate-spin w-6 h-6 border-2 border-orange-500/30 border-t-orange-500 rounded-full mx-auto mb-2"></div><p class="text-xs text-slate-400">Buscando time...</p></div>';
                    }
                    
                    if (meusTimesIds.length === 0) {
                        h += '<div class="bg-black/20 p-6 rounded-lg text-center"><i class="fas fa-users text-3xl text-slate-700 mb-2"></i><p class="text-xs text-slate-500">Nenhum time adicionado ainda.</p><p class="text-[10px] text-slate-600 mt-1">Adicione seu time e de amigos para acompanhar as parciais.</p></div>';
                    } else {
                        // Ordenar por pontuação
                        const timesOrdenados = meusTimesIds.map(id => meusTimesData[id] || {slug: id, nome: id, pontos: '-', loading: true}).sort((a,b) => (b.pontos_rodada || 0) - (a.pontos_rodada || 0));
                        h += '<div class="space-y-2">';
                        timesOrdenados.forEach((t, i) => {
                            h += '<div class="bg-black/20 p-3 rounded-lg">' +
                                '<div class="flex items-center gap-3">' +
                                    '<div class="w-7 h-7 rounded-full ' + (i === 0 ? 'bg-orange-500/30 text-orange-400' : 'bg-white/5 text-slate-500') + ' flex items-center justify-center font-bold text-xs">' + (i+1) + '</div>' +
                                    (t.url_escudo ? '<img src="' + t.url_escudo + '" class="w-8 h-8 rounded-full object-cover bg-black/30">' : '<div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center"><i class="fas fa-user text-slate-600 text-xs"></i></div>') +
                                    '<div class="flex-1 min-w-0">' +
                                        '<div class="text-xs font-bold text-white truncate">' + (t.nome || t.slug) + '</div>' +
                                        '<div class="text-[9px] text-slate-500">' + (t.nome_cartoleiro || '') + '</div>' +
                                    '</div>' +
                                    '<div class="text-right">' +
                                        '<div class="text-lg font-black ' + ((t.pontos_rodada || 0) >= 0 ? 'text-green-400' : 'text-red-400') + '">' + (t.pontos_rodada !== undefined ? t.pontos_rodada : '-') + '</div>' +
                                        '<div class="text-[9px] text-slate-500">Rodada</div>' +
                                    '</div>' +
                                    '<div class="text-right ml-2">' +
                                        '<div class="text-sm font-bold text-orange-400">' + (t.pontos_total !== undefined ? t.pontos_total : '-') + '</div>' +
                                        '<div class="text-[9px] text-slate-500">Total</div>' +
                                    '</div>' +
                                    '<button onclick="CartolaActions.removerTime(\'' + t.slug + '\')" class="ml-1 text-slate-700 hover:text-red-400 text-xs"><i class="fas fa-times"></i></button>' +
                                '</div>' +
                                (t.atletas && t.atletas.length > 0 ? '<div class="mt-2 flex flex-wrap gap-1">' + t.atletas.map(a => '<span class="text-[9px] px-1.5 py-0.5 rounded bg-black/30 ' + (a.pontos >= 0 ? 'text-green-400' : 'text-red-400') + '">' + a.apelido + ' ' + a.pontos + '</span>').join('') + '</div>' : '') +
                            '</div>';
                        });
                        h += '</div>';
                        h += '<button onclick="CartolaActions.atualizarMeusTimes()" class="w-full mt-3 px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 text-xs font-bold rounded-lg"><i class="fas fa-sync-alt mr-1"></i>Atualizar Parciais dos Times</button>';
                    }
                }
                
                return h;
            },
            Cartola: () => {
                return '<div class="animate-fade-in space-y-4 pb-20">' +
                    '<div class="bg-gradient-to-br from-orange-900/30 to-app-bg p-6 rounded-2xl border border-orange-500/20 shadow-2xl">' +
                        '<div class="flex items-center justify-between">' +
                            '<div><h2 class="text-2xl font-black text-white mb-1"><i class="fas fa-futbol text-orange-400 mr-2"></i>Cartola FC</h2>' +
                            '<p class="text-xs text-slate-400">Parciais em tempo real da rodada</p></div>' +
                            '<button onclick="Data._cartolaLoading=false;CartolaActions.carregar()" class="px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 text-xs font-bold rounded-lg transition-all"><i class="fas fa-sync-alt mr-1"></i>Atualizar</button>' +
                        '</div>' +
                    '</div>' +
                    '<div id="cartola-content">' + Views.CartolaContent() + '</div>' +
                '</div>';
            },
                        Admin: () => {
                if (!Auth.user || Auth.user.email !== 'mateusmachado11m@gmail.com') {
                    return `<div class="animate-fade-in text-center py-20"><i class="fas fa-lock text-6xl text-slate-700 mb-4"></i><p class="text-slate-500">Acesso Restrito</p></div>`;
                }
                return `
                <div class="animate-fade-in space-y-6">
                    <h2 class="text-white font-bold text-2xl mb-6"><i class="fas fa-shield-alt mr-2"></i>Painel Administrativo</h2>
                    
                    <!-- ALERTAS -->
                    <div id="alertas-container" class="bg-app-surface p-6 rounded-xl border border-white/5">
                        <h3 class="text-white font-bold mb-4"><i class="fas fa-bell mr-2"></i>Alertas</h3>
                        <div id="alertas-list" class="space-y-2">
                            <p class="text-sm text-slate-400">Carregando...</p>
                        </div>
                    </div>
                    
                    <!-- ATUALIZAR PROGRAMAÇÃO -->
                    <div class="bg-app-surface p-6 rounded-xl border border-white/5">
                        <h3 class="text-white font-bold mb-4"><i class="fas fa-calendar-plus mr-2"></i>Atualizar Programação</h3>
                        <p class="text-sm text-slate-400 mb-4">Cole os dados copiados pelo bookmarklet (Ctrl+V):</p>
                        <textarea id="html-programacao" class="w-full h-40 bg-black/30 border border-white/10 rounded-lg p-3 text-white text-xs font-mono" placeholder='Cole os dados JSON aqui... Exemplo: {"tipo":"programacao","concurso":"1229","jogos":[...]}'></textarea>
                        <button onclick="AdminActions.processar('programacao')" class="mt-3 w-full py-3 bg-app-primary hover:bg-green-600 text-black font-bold rounded-lg transition-all">
                            <i class="fas fa-upload mr-2"></i>PROCESSAR PROGRAMAÇÃO
                        </button>
                    </div>
                    
                    <!-- ATUALIZAR RESULTADOS -->
                    <div class="bg-app-surface p-6 rounded-xl border border-white/5">
                        <h3 class="text-white font-bold mb-4"><i class="fas fa-trophy mr-2"></i>Atualizar Resultados</h3>
                        <p class="text-sm text-slate-400 mb-4">Cole os dados copiados pelo bookmarklet (Ctrl+V):</p>
                        <textarea id="html-resultados" class="w-full h-40 bg-black/30 border border-white/10 rounded-lg p-3 text-white text-xs font-mono" placeholder='Cole os dados JSON aqui... Exemplo: {"tipo":"resultado","concurso":"1228","jogos":[...]}'></textarea>
                        <button onclick="AdminActions.processar('resultados')" class="mt-3 w-full py-3 bg-app-primary hover:bg-green-600 text-black font-bold rounded-lg transition-all">
                            <i class="fas fa-upload mr-2"></i>PROCESSAR RESULTADOS
                        </button>
                    </div>
                    
                    <div id="admin-feedback" class="hidden bg-green-500/20 border border-green-500/50 rounded-lg p-4 text-green-400 text-sm"></div>
                    
                    <!-- REGENERAR ANÁLISE IA -->
                    <div class="bg-app-surface p-6 rounded-xl border border-violet-500/20">
                        <h3 class="text-white font-bold mb-4"><i class="fas fa-robot mr-2 text-violet-400"></i>Regenerar Análise IA</h3>
                        <p class="text-sm text-slate-400 mb-4">Se a análise não foi gerada corretamente, selecione o concurso e clique para regenerar.</p>
                        <div class="flex gap-3">
                            <select id="regen-concurso" class="flex-1 bg-black/30 border border-white/10 rounded-lg p-3 text-white text-sm">
                                <option value="">Selecione o concurso...</option>
                            </select>
                            <button onclick="AdminActions.regenerarAnalise()" class="px-6 py-3 bg-violet-500 hover:bg-violet-600 text-white font-bold rounded-lg transition-all">
                                <i class="fas fa-sync-alt mr-2"></i>REGENERAR
                            </button>
                        </div>
                        <div id="regen-feedback" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
                    </div>
                    
                    <!-- PREVIEW E PUBLICAÇÃO -->
                    <div id="preview-container" class="hidden">
                        <div class="bg-app-surface p-6 rounded-xl border border-white/5">
                            <h3 class="text-white font-bold text-xl mb-4"><i class="fas fa-eye mr-2"></i>Preview - Confira os Dados</h3>
                            <div id="preview-content" class="space-y-4"></div>
                            <div class="flex gap-4 mt-6">
                                <button onclick="AdminActions.publicar()" class="flex-1 py-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition-all text-lg">
                                    <i class="fas fa-check-circle mr-2"></i>PUBLICAR NO SITE
                                </button>
                                <button onclick="AdminActions.cancelarPreview()" class="px-6 py-4 bg-red-500/20 hover:bg-red-500/30 text-red-400 font-bold rounded-lg transition-all border border-red-500/50">
                                    <i class="fas fa-times mr-2"></i>CANCELAR
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            },
            Prices: () => {
                const precos = [
                    {d:1,t:0,a:2,v:'R$ 4,00'},{d:2,t:0,a:4,v:'R$ 8,00'},{d:3,t:0,a:8,v:'R$ 16,00'},{d:4,t:0,a:16,v:'R$ 32,00'},{d:5,t:0,a:32,v:'R$ 64,00'},{d:6,t:0,a:64,v:'R$ 128,00'},{d:7,t:0,a:128,v:'R$ 256,00'},{d:8,t:0,a:256,v:'R$ 512,00'},{d:9,t:0,a:512,v:'R$ 1.024,00'},
                    {d:0,t:1,a:3,v:'R$ 6,00'},{d:1,t:1,a:6,v:'R$ 12,00'},{d:2,t:1,a:12,v:'R$ 24,00'},{d:3,t:1,a:24,v:'R$ 48,00'},{d:4,t:1,a:48,v:'R$ 96,00'},{d:5,t:1,a:96,v:'R$ 192,00'},{d:6,t:1,a:192,v:'R$ 384,00'},{d:7,t:1,a:384,v:'R$ 768,00'},{d:8,t:1,a:768,v:'R$ 1.536,00'},
                    {d:0,t:2,a:9,v:'R$ 18,00'},{d:1,t:2,a:18,v:'R$ 36,00'},{d:2,t:2,a:36,v:'R$ 72,00'},{d:3,t:2,a:72,v:'R$ 144,00'},{d:4,t:2,a:144,v:'R$ 288,00'},{d:5,t:2,a:288,v:'R$ 576,00'},{d:6,t:2,a:576,v:'R$ 1.152,00'},
                    {d:0,t:3,a:27,v:'R$ 54,00'},{d:1,t:3,a:54,v:'R$ 108,00'},{d:2,t:3,a:108,v:'R$ 216,00'},{d:3,t:3,a:216,v:'R$ 432,00'},{d:4,t:3,a:432,v:'R$ 864,00'},{d:5,t:3,a:864,v:'R$ 1.728,00'},
                    {d:0,t:4,a:81,v:'R$ 162,00'},{d:1,t:4,a:162,v:'R$ 324,00'},{d:2,t:4,a:324,v:'R$ 648,00'},{d:3,t:4,a:648,v:'R$ 1.296,00'},
                    {d:0,t:5,a:243,v:'R$ 486,00'},{d:1,t:5,a:486,v:'R$ 972,00'},
                    {d:0,t:6,a:729,v:'R$ 1.458,00'}
                ];
                const [filtroTriplo, setFiltro] = [State.filtroTriplo || 'todos', (v) => { State.filtroTriplo = v; Router.render(); }];
                const filtered = filtroTriplo === 'todos' ? precos : precos.filter(p => p.t === parseInt(filtroTriplo));
                return `
                <div class="animate-fade-in space-y-6">
                    <div class="bg-gradient-to-br from-app-surface to-app-bg p-6 rounded-2xl border border-app-primary/20 shadow-2xl">
                        <h2 class="text-2xl font-black text-white mb-2"><i class="fas fa-tag text-app-primary mr-2"></i>Tabela de Precos da Loteca</h2>
                        <p class="text-sm text-slate-300">Precos oficiais da Caixa Economica Federal - Vigente desde Julho/2025</p>
                    </div>

                    <!-- COMO FUNCIONA -->
                    <div class="bg-app-surface p-6 rounded-xl border border-white/5">
                        <h3 class="text-white font-bold mb-4"><i class="fas fa-info-circle text-blue-400 mr-2"></i>Como Funciona</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                                <div class="text-2xl mb-2"><i class="fas fa-futbol text-green-400"></i></div>
                                <h4 class="text-white font-bold text-sm mb-1">Aposta Simples</h4>
                                <p class="text-xs text-slate-400">Marque 1 palpite por jogo nos 14 jogos + 1 duplo obrigatorio. Valor: <span class="text-app-primary font-bold">R$ 4,00</span></p>
                            </div>
                            <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                                <div class="text-2xl mb-2"><i class="fas fa-clone text-yellow-400"></i></div>
                                <h4 class="text-white font-bold text-sm mb-1">Duplo</h4>
                                <p class="text-xs text-slate-400">Marque 2 resultados para o mesmo jogo. Cada duplo <span class="text-yellow-400 font-bold">dobra</span> o valor da aposta.</p>
                            </div>
                            <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                                <div class="text-2xl mb-2"><i class="fas fa-layer-group text-red-400"></i></div>
                                <h4 class="text-white font-bold text-sm mb-1">Triplo</h4>
                                <p class="text-xs text-slate-400">Marque os 3 resultados para o mesmo jogo. Cada triplo <span class="text-red-400 font-bold">triplica</span> o valor da aposta.</p>
                            </div>
                        </div>
                    </div>

                    <!-- CALCULADORA RAPIDA -->
                    <div class="bg-app-surface p-6 rounded-xl border border-violet-500/20">
                        <h3 class="text-white font-bold mb-4"><i class="fas fa-calculator text-violet-400 mr-2"></i>Calculadora Rapida</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-xs text-slate-400 block mb-1">Duplos</label>
                                <input type="number" id="calc-duplos" min="0" max="14" value="1" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white text-center text-lg font-bold" onchange="Actions.calcularPreco()">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 block mb-1">Triplos</label>
                                <input type="number" id="calc-triplos" min="0" max="14" value="0" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white text-center text-lg font-bold" onchange="Actions.calcularPreco()">
                            </div>
                        </div>
                        <div id="calc-resultado" class="bg-black/30 p-4 rounded-lg border border-violet-500/20 text-center">
                            <div class="text-xs text-slate-400 mb-1">Valor da Aposta</div>
                            <div class="text-3xl font-black text-app-primary">R$ 4,00</div>
                            <div class="text-xs text-slate-500 mt-1">2 apostas</div>
                        </div>
                    </div>

                    <!-- FILTRO -->
                    <div class="bg-app-surface p-4 rounded-xl border border-white/5">
                        <div class="flex items-center gap-3 flex-wrap">
                            <span class="text-xs text-slate-400 font-bold">Filtrar por triplos:</span>
                            ${['todos','0','1','2','3','4','5','6'].map(v => {
                                const isActive = filtroTriplo === v;
                                const label = v === 'todos' ? 'Todos' : v + (v === '1' ? ' triplo' : ' triplos');
                                return `<button onclick="State.filtroTriplo='${v}'; Router.render()" class="px-3 py-1 rounded-full text-xs font-bold transition-all ${isActive ? 'bg-app-primary text-black' : 'bg-white/5 text-slate-400 hover:bg-white/10'}">${label}</button>`;
                            }).join('')}
                        </div>
                    </div>

                    <!-- TABELA -->
                    <div class="bg-app-surface rounded-xl border border-white/5 overflow-hidden">
                        <div class="grid grid-cols-4 gap-0 bg-black/40 p-3 border-b border-white/10">
                            <div class="text-xs font-bold text-slate-300 text-center">Duplos</div>
                            <div class="text-xs font-bold text-slate-300 text-center">Triplos</div>
                            <div class="text-xs font-bold text-slate-300 text-center">Apostas</div>
                            <div class="text-xs font-bold text-slate-300 text-center">Valor</div>
                        </div>
                        ${filtered.map((p, i) => {
                            const bgClass = i % 2 === 0 ? 'bg-black/10' : '';
                            const isSimples = p.d === 1 && p.t === 0;
                            return `<div class="grid grid-cols-4 gap-0 p-3 border-b border-white/5 ${bgClass} ${isSimples ? 'bg-app-primary/10 border-l-4 border-l-app-primary' : ''}">
                                <div class="text-sm text-white text-center font-bold">${p.d}</div>
                                <div class="text-sm text-white text-center font-bold">${p.t}</div>
                                <div class="text-sm text-slate-300 text-center">${p.a.toLocaleString('pt-BR')}</div>
                                <div class="text-sm text-center font-bold ${isSimples ? 'text-app-primary' : 'text-white'}">${p.v}</div>
                            </div>`;
                        }).join('')}
                    </div>

                    <!-- PREMIACAO -->
                    <div class="bg-app-surface p-6 rounded-xl border border-white/5">
                        <h3 class="text-white font-bold mb-4"><i class="fas fa-trophy text-yellow-400 mr-2"></i>Premiacao</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between bg-black/20 p-4 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center"><span class="text-yellow-400 font-black">1</span></div>
                                    <div><div class="text-white font-bold text-sm">14 Acertos</div><div class="text-xs text-slate-400">Premio principal</div></div>
                                </div>
                                <div class="text-app-primary font-black text-lg">70%</div>
                            </div>
                            <div class="flex items-center justify-between bg-black/20 p-4 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-500/20 flex items-center justify-center"><span class="text-slate-300 font-black">2</span></div>
                                    <div><div class="text-white font-bold text-sm">13 Acertos</div><div class="text-xs text-slate-400">Premio secundario</div></div>
                                </div>
                                <div class="text-slate-300 font-black text-lg">15%</div>
                            </div>
                            <div class="flex items-center justify-between bg-black/20 p-4 rounded-lg border border-amber-500/20">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center"><i class="fas fa-star text-amber-400 text-sm"></i></div>
                                    <div><div class="text-white font-bold text-sm">Concursos Especiais</div><div class="text-xs text-slate-400">Finais 0 e 5 - acumula p/ 14 acertos</div></div>
                                </div>
                                <div class="text-amber-400 font-black text-lg">15%</div>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-4">* O premio bruto corresponde a 55% da arrecadacao total do concurso. Nos concursos de final 0 ou 5, os 15% reservados sao distribuidos aos acertadores de 14 jogos como premio extra.</p>
                    </div>

                    <!-- BOLAO -->
                    <div class="bg-app-surface p-6 rounded-xl border border-white/5">
                        <h3 class="text-white font-bold mb-4"><i class="fas fa-users text-blue-400 mr-2"></i>Bolao</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-black/20 p-4 rounded-lg text-center">
                                <div class="text-2xl font-black text-white">R$ 16</div>
                                <div class="text-xs text-slate-400 mt-1">Valor minimo</div>
                            </div>
                            <div class="bg-black/20 p-4 rounded-lg text-center">
                                <div class="text-2xl font-black text-white">R$ 4</div>
                                <div class="text-xs text-slate-400 mt-1">Cota minima</div>
                            </div>
                            <div class="bg-black/20 p-4 rounded-lg text-center">
                                <div class="text-2xl font-black text-white">2-50</div>
                                <div class="text-xs text-slate-400 mt-1">Participantes</div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            },
            Ranking: () => {
                const [activeTab, setTab] = [State.rankingTab || 'round', (t) => { State.rankingTab = t; Router.render(); }];
                const data = Data.ranking[activeTab];
                const currentUser = Auth.user ? { name: Auth.user.displayName, avatar: Auth.user.displayName[0].toUpperCase(), position: 5, points: 42, hits: 42 } : null;
                
                const renderUser = (user, index) => {
                    const medals = ['🥇', '🥈', '🥉'];
                    const medal = index < 3 ? medals[index] : `${index + 1}º`;
                    const bgClass = index < 3 ? 'bg-gradient-to-r from-yellow-600/20 to-orange-600/20 border-yellow-500/30' : 'bg-app-surface border-white/5';
                    return `
                        <div class="flex items-center gap-4 p-4 rounded-xl border ${bgClass} hover:bg-white/5 transition-all">
                            <span class="text-2xl font-black w-12 text-center">${medal}</span>
                            <div class="w-12 h-12 rounded-full bg-app-primary flex items-center justify-center text-sm font-black text-black">${user.avatar}</div>
                            <div class="flex-1">
                                <h3 class="text-sm font-bold text-white">${user.name}</h3>
                                <p class="text-xs text-slate-400">${user.hits} acertos${activeTab !== 'round' ? ' • ' + user.rounds + ' concursos' : ''}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-app-primary">${user.points}</div>
                                <div class="text-[10px] text-slate-500 uppercase">pontos</div>
                            </div>
                        </div>
                    `;
                };
                
                return `
                    <div class="animate-fade-in space-y-6">
                        <div class="bg-gradient-to-br from-app-surface to-app-bg p-6 rounded-2xl border border-app-primary/20 shadow-2xl">
                            <h2 class="text-2xl font-black text-white mb-2"><i class="fas fa-trophy text-app-primary mr-2"></i>Ranking de Lotequeiros</h2>
                            <p class="text-sm text-slate-300 mb-6">Veja quem são os melhores palpiteiros do Brasil!</p>
                            
                            ${currentUser ? `
                                <div class="bg-app-primary/10 border-2 border-app-primary/30 rounded-xl p-4 mb-6">
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-full bg-app-primary flex items-center justify-center text-xl font-black text-black">${currentUser.avatar}</div>
                                        <div class="flex-1">
                                            <h3 class="text-lg font-bold text-white">${currentUser.name}</h3>
                                            <p class="text-xs text-slate-400">Sua posição no ranking</p>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-3xl font-black text-app-primary">${currentUser.position}º</div>
                                            <div class="text-[10px] text-slate-500 uppercase">Posição</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-3xl font-black text-app-primary">${currentUser.points}</div>
                                            <div class="text-[10px] text-slate-500 uppercase">Pontos</div>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-6 text-center">
                                    <p class="text-sm text-slate-400 mb-3">Faça login para ver sua posição no ranking!</p>
                                    <button onclick="Router.openModal('login')" class="bg-app-primary text-black font-bold py-2 px-6 rounded-lg text-sm hover:bg-green-400 transition-all">
                                        <i class="fas fa-sign-in-alt mr-2"></i>ENTRAR
                                    </button>
                                </div>
                            `}
                            
                            <div class="bg-black/20 p-4 rounded-lg border border-white/10 mb-6">
                                <h3 class="text-sm font-bold text-white mb-2"><i class="fas fa-info-circle text-app-primary mr-2"></i>Como Funciona a Pontuação</h3>
                                <div class="space-y-1 text-xs text-slate-300">
                                    <p>• <strong>1 ponto</strong> por cada resultado correto</p>
                                    <p>• <strong>28 pontos (dobro)</strong> ao acertar todos os 14 jogos</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-app-surface rounded-2xl border border-white/5 overflow-hidden shadow-xl">
                            <div class="bg-black/20 p-4 border-b border-white/5 flex gap-2">
                                <button onclick="State.rankingTab='round'; Router.render();" class="flex-1 py-2 px-4 rounded-lg text-xs font-bold transition-all ${activeTab === 'round' ? 'bg-app-primary text-black' : 'text-slate-400 hover:text-white hover:bg-white/5'}">
                                    CONCURSO ATUAL
                                </button>
                                <button onclick="State.rankingTab='month'; Router.render();" class="flex-1 py-2 px-4 rounded-lg text-xs font-bold transition-all ${activeTab === 'month' ? 'bg-app-primary text-black' : 'text-slate-400 hover:text-white hover:bg-white/5'}">
                                    MÊS
                                </button>
                                <button onclick="State.rankingTab='year'; Router.render();" class="flex-1 py-2 px-4 rounded-lg text-xs font-bold transition-all ${activeTab === 'year' ? 'bg-app-primary text-black' : 'text-slate-400 hover:text-white hover:bg-white/5'}">
                                    ANO
                                </button>
                            </div>
                            <div class="p-4 space-y-3">
                                ${data.map((user, i) => renderUser(user, i)).join('')}
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="Router.navigate('palpites')" class="flex-1 bg-gradient-to-r from-app-primary to-green-500 hover:from-green-500 hover:to-app-primary text-black font-black py-4 rounded-xl shadow-2xl transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-pen-to-square"></i>DÊ SEU PALPITE AGORA
                            </button>
                        </div>
                    </div>
                `;
            },
            LoginModal: () => `
                <div class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div class="w-full max-w-sm bg-app-surface border border-white/10 rounded-2xl p-8 shadow-2xl relative text-center">
                        <button onclick="Router.closeModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
                        <div class="bg-app-primary/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-app-primary text-2xl"><i class="fas fa-user-shield"></i></div>
                        <h2 class="text-xl font-bold text-white mb-2">Área do Lotequeiro</h2>
                        <p class="text-xs text-slate-400 mb-8">Entre para salvar seus palpites e participar do ranking nacional.</p>
                        <button onclick="Auth.loginWithGoogle()" class="w-full bg-white text-black font-bold py-3 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-100 transition-all active:scale-95">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" class="w-5 h-5"> Entrar com Google
                        </button>
                        <div class="mt-6 pt-6 border-t border-white/5">
                            <p class="text-[10px] text-slate-500">Ao entrar, você concorda com nossos termos de uso.</p>
                        </div>
                    </div>
                </div>
            `
        };

        // --- ROUTER ---
        const State = { currentRoute: 'home', modal: null };
        const Router = {
            navigate: (route) => { State.currentRoute = route; Router.renderMenu(); Router.render(); window.scrollTo(0,0); },
            openModal: (type) => { State.modal = type; Router.render(); },
            closeModal: () => { State.modal = null; Router.render(); },
            renderMenu: () => {
                const routes = [
                    { id: 'home', icon: 'fa-home', label: 'Início' },
                    { id: 'ai-xray', icon: 'fa-microchip', label: 'Raio X IA', special: true },
                    { id: 'ranking', icon: 'fa-medal', label: 'Ranking' },
                    { id: 'palpites', icon: 'fa-pen-to-square', label: 'Palpites' },
                    { id: 'market', icon: 'fa-exchange-alt', label: 'Mercado' },
                    { id: 'montador', icon: 'fa-gamepad', label: 'Monte seu Jogo' },
                    { id: 'cartola', icon: 'fa-futbol', label: 'Cartola' },
                    { id: 'prices', icon: 'fa-tag', label: 'Preços' }
                ];
                
                // Adicionar Admin se for o administrador
                if (Auth.user && Auth.user.email === 'mateusmachado11m@gmail.com') {
                    routes.push({ id: 'admin', icon: 'fa-shield-alt', label: 'Admin', admin: true });
                }
                document.getElementById('horizontal-menu').innerHTML = routes.map(r => {
                    const isActive = State.currentRoute === r.id;
                    const cls = r.special ? (isActive ? 'bg-app-ai text-white' : 'text-app-ai bg-app-ai/10 border border-app-ai/20') : (isActive ? 'bg-app-primary/10 text-app-primary border-b-2 border-app-primary' : 'text-slate-400 hover:text-white hover:bg-white/5');
                    return `<button onclick="Router.navigate('${r.id}')" class="nav-item flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all ${cls}"><i class="fas ${r.icon}"></i><span>${r.label}</span></button>`;
                }).join('');
            },
            render: () => {
                const main = document.getElementById('main-content');
                switch(State.currentRoute) {
                    case 'home': main.innerHTML = Views.Home(); break;
                    case 'analysis-previous': main.innerHTML = Views.AnalysisPrevious(); break;
                    case 'analysis-current': main.innerHTML = Views.AnalysisCurrent(); break;
                    case 'palpites': main.innerHTML = Views.Palpites(); break;
                    case 'ai-xray': main.innerHTML = Views.AiXray(); break;
                    case 'market': main.innerHTML = Views.Market(); setTimeout(() => MercadoActions.carregarSeNecessario(), 100); break;
                    case 'prices': main.innerHTML = Views.Prices(); break;
                    case 'montador': main.innerHTML = Views.Montador(); break;
                    case 'cartola': main.innerHTML = Views.Cartola(); if (!Data._cartolaData && !Data._cartolaLoading) setTimeout(() => CartolaActions.carregar(), 100); break;
                    case 'ranking': main.innerHTML = Views.Ranking(); break;
                    case 'admin': main.innerHTML = Views.Admin(); setTimeout(() => { AdminActions.carregarAlertas(); AdminActions.carregarConcursosParaRegen(); }, 500); break;
                }
                if(State.modal === 'login') {
                    const div = document.createElement('div');
                    div.innerHTML = Views.LoginModal();
                    main.appendChild(div.firstElementChild);
                }
            }
        };

        // --- ACTIONS ---
        const Actions = {
            vote: (gid, type) => {
                Store.setVote(gid, type);
                // Atualizar apenas os botões do jogo clicado (sem re-renderizar toda a página)
                const data = Store.getAppData();
                const row = document.querySelector(`[data-game-id="${gid}"]`);
                if (row) {
                    const buttons = row.querySelectorAll('button[data-vote-type]');
                    buttons.forEach(btn => {
                        const t = btn.getAttribute('data-vote-type');
                        const isSel = data.votes[gid] === t;
                        btn.className = `h-9 w-full rounded flex items-center justify-center text-xs transition-all hover:scale-105 ${
                            isSel ? 'bg-blue-500 text-white font-bold' : 'bg-slate-800 text-slate-400'
                        }`;
                        btn.innerHTML = isSel ? '<i class="fas fa-check"></i>' : (t==='h'?'1':(t==='d'?'X':'2'));
                    });
                    // Atualizar barra de progresso
                    const voteCount = Object.keys(data.votes).length;
                    const progress = Math.round((voteCount / 14) * 100);
                    const progressBar = document.getElementById('vote-progress-bar');
                    const progressText = document.getElementById('vote-progress-text');
                    if (progressBar) progressBar.style.width = progress + '%';
                    if (progressText) progressText.textContent = voteCount + '/14';
                } else {
                    Router.render();
                }
            },
            submitVotes: () => {
                if(!Auth.user) { Router.openModal('login'); return; }
                const d = Store.getAppData();
                if(Object.keys(d.votes).length < 14) { alert("Preencha os 14 jogos!"); return; }
                d.submitted = true;
                Store.saveAppData(d);
                Router.render();
            },
            resetVotes: () => { localStorage.removeItem(Store.KEY_DATA); Router.render(); },
            calcularPreco: () => {
                const duplos = parseInt(document.getElementById('calc-duplos')?.value || '1');
                const triplos = parseInt(document.getElementById('calc-triplos')?.value || '0');
                const apostas = Math.pow(2, duplos) * Math.pow(3, triplos);
                const valor = apostas * 2; // R$ 2,00 por aposta
                const el = document.getElementById('calc-resultado');
                if (el) {
                    el.innerHTML = `
                        <div class="text-xs text-slate-400 mb-1">Valor da Aposta</div>
                        <div class="text-3xl font-black text-app-primary">R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        <div class="text-xs text-slate-500 mt-1">${apostas.toLocaleString('pt-BR')} apostas</div>
                    `;
                }
            }
        };

        // ANÁLISE COM IA
        // Função utilitária para limpar textos que podem conter JSON bruto da IA
        function limparTextoIA(texto) {
            if (!texto || typeof texto !== 'string') return texto || '';
            // Se o texto começa com ```json, tentar extrair o JSON e pegar o campo correto
            let limpo = texto.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            // Se parece ser um JSON, tentar parsear e extrair campos
            if (limpo.startsWith('{')) {
                // Tentar parsear diretamente
                try {
                    const parsed = JSON.parse(limpo);
                    if (parsed.resumo && parsed.detalhada) return parsed;
                    if (parsed.resumo) return parsed.resumo;
                    if (parsed.detalhada) return parsed.detalhada;
                } catch(e) {
                    // JSON pode ter newlines dentro de strings - substituir por \\n
                    try {
                        const inicio = limpo.indexOf('{');
                        const fim = limpo.lastIndexOf('}');
                        if (inicio >= 0 && fim > inicio) {
                            let jsonStr = limpo.substring(inicio, fim + 1);
                            jsonStr = jsonStr.replace(/\n/g, '\\n');
                            const parsed2 = JSON.parse(jsonStr);
                            if (parsed2.resumo && parsed2.detalhada) return parsed2;
                            if (parsed2.resumo) return parsed2.resumo;
                            if (parsed2.detalhada) return parsed2.detalhada;
                        }
                    } catch(e2) {
                        // Tentar regex como último recurso
                        const matchR = limpo.match(/"resumo"\s*:\s*"([^"]+)"/); 
                        const matchD = limpo.match(/"detalhada"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/s);
                        if (matchR || matchD) {
                            return {
                                resumo: matchR ? matchR[1] : '',
                                detalhada: matchD ? matchD[1].replace(/\\n/g, '\n') : ''
                            };
                        }
                    }
                }
            }
            return limpo;
        }

        // === SISTEMA DE PROGRESSO VISUAL ===
        const ProgressOverlay = {
            _el: null,
            _timer: null,
            _seconds: 0,
            _steps: [],
            _currentStep: 0,

            show(title, steps) {
                this._seconds = 0;
                this._currentStep = 0;
                this._steps = steps;
                this.remove();

                const stepsHtml = steps.map((s, i) => `
                    <div class="step-item step-pending" id="prog-step-${i}">
                        <div class="step-icon"><i class="fas ${s.icon}"></i></div>
                        <div>
                            <div class="step-label text-sm">${s.label}</div>
                            <div class="step-sublabel" id="prog-sub-${i}">${s.sublabel || 'Aguardando...'}</div>
                        </div>
                    </div>
                `).join('');

                const html = `
                    <div class="progress-overlay" id="progress-overlay">
                        <div class="progress-card">
                            <div class="text-center mb-5">
                                <div class="text-2xl mb-1"><i class="fas fa-robot text-violet-400"></i></div>
                                <h3 class="text-white font-bold text-lg">${title}</h3>
                                <p class="text-slate-400 text-xs mt-1">Nao feche esta pagina</p>
                            </div>
                            <div class="progress-bar-bg mb-4">
                                <div class="progress-bar-fill" id="prog-bar" style="width:0%"></div>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-xs text-slate-500" id="prog-percent">0%</span>
                                <span class="text-xs text-slate-400 timer-display" id="prog-timer">00:00</span>
                            </div>
                            <div class="space-y-0" id="prog-steps">${stepsHtml}</div>
                            <div id="prog-result" class="hidden mt-4 p-3 rounded-lg text-sm text-center"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', html);
                this._el = document.getElementById('progress-overlay');
                this._timer = setInterval(() => {
                    this._seconds++;
                    const m = String(Math.floor(this._seconds / 60)).padStart(2, '0');
                    const s = String(this._seconds % 60).padStart(2, '0');
                    const te = document.getElementById('prog-timer');
                    if (te) te.textContent = `${m}:${s}`;
                }, 1000);
                this.activateStep(0);
            },

            activateStep(index, sublabel) {
                this._currentStep = index;
                const total = this._steps.length;
                const pct = Math.round((index / total) * 100);
                const bar = document.getElementById('prog-bar');
                const pctEl = document.getElementById('prog-percent');
                if (bar) bar.style.width = pct + '%';
                if (pctEl) pctEl.textContent = pct + '%';

                for (let i = 0; i < total; i++) {
                    const el = document.getElementById(`prog-step-${i}`);
                    if (!el) continue;
                    if (i < index) {
                        el.className = 'step-item step-done';
                        el.querySelector('.step-icon').innerHTML = '<i class="fas fa-check"></i>';
                    } else if (i === index) {
                        el.className = 'step-item step-active';
                        el.querySelector('.step-icon').innerHTML = `<i class="fas ${this._steps[i].icon}"></i>`;
                        if (sublabel) {
                            const sub = document.getElementById(`prog-sub-${i}`);
                            if (sub) sub.textContent = sublabel;
                        }
                    } else {
                        el.className = 'step-item step-pending';
                    }
                }
            },

            updateSublabel(index, text) {
                const sub = document.getElementById(`prog-sub-${index}`);
                if (sub) sub.textContent = text;
            },

            completeStep(index) {
                const el = document.getElementById(`prog-step-${index}`);
                if (el) {
                    el.className = 'step-item step-done';
                    el.querySelector('.step-icon').innerHTML = '<i class="fas fa-check"></i>';
                }
            },

            errorStep(index, msg) {
                const el = document.getElementById(`prog-step-${index}`);
                if (el) {
                    el.className = 'step-item step-error';
                    el.querySelector('.step-icon').innerHTML = '<i class="fas fa-times"></i>';
                    const sub = document.getElementById(`prog-sub-${index}`);
                    if (sub) sub.textContent = msg || 'Erro';
                }
            },

            finish(success, message) {
                if (this._timer) { clearInterval(this._timer); this._timer = null; }
                const bar = document.getElementById('prog-bar');
                const pctEl = document.getElementById('prog-percent');
                if (bar) bar.style.width = '100%';
                if (pctEl) pctEl.textContent = '100%';

                // Marcar todas as steps restantes como done
                for (let i = 0; i <= this._currentStep; i++) {
                    this.completeStep(i);
                }

                const res = document.getElementById('prog-result');
                if (res) {
                    res.classList.remove('hidden');
                    if (success) {
                        res.className = 'mt-4 p-3 rounded-lg text-sm text-center bg-green-500/20 border border-green-500/30 text-green-300';
                        res.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
                    } else {
                        res.className = 'mt-4 p-3 rounded-lg text-sm text-center bg-red-500/20 border border-red-500/30 text-red-300';
                        res.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
                    }
                }

                // Auto-fechar após 3 segundos se sucesso
                if (success) {
                    setTimeout(() => this.remove(), 3000);
                } else {
                    // Adicionar botão fechar se erro
                    if (res) {
                        res.innerHTML += `<br><button onclick="ProgressOverlay.remove()" class="mt-2 px-4 py-1 bg-slate-600 hover:bg-slate-500 text-white text-xs rounded-lg">FECHAR</button>`;
                    }
                }
            },

            remove() {
                if (this._timer) { clearInterval(this._timer); this._timer = null; }
                const el = document.getElementById('progress-overlay');
                if (el) el.remove();
                this._el = null;
            }
        };

        const AIAnalyzer = {
            async analisarConcurso(dados) {
                try {
                    console.log('Iniciando análise com IA para concurso', dados.concurso);
                    
                    const prompt = dados.tipo === 'programacao' 
                        ? this.gerarPromptProgramacao(dados)
                        : this.gerarPromptResultados(dados);
                    
                    console.log('Enviando para Cloud Function...');
                    
                    const idToken = await firebase.auth().currentUser.getIdToken();
                    
                    const response = await fetch('https://us-central1-loteca-pro-mateus-1767825041.cloudfunctions.net/gerarAnaliseIA', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + idToken
                        },
                        body: JSON.stringify({
                            tipo: dados.tipo,
                            concurso: dados.concurso,
                            jogos: dados.jogos
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Erro na resposta da API:', response.status, errorText);
                        throw new Error(`API retornou erro: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Resposta da Cloud Function:', result);
                    
                    if (!result.success || !result.analise) {
                        console.error('Resposta inválida:', result);
                        throw new Error(result.error || 'Resposta inválida');
                    }
                    
                    // Limpar textos que podem conter JSON bruto
                    let resumo = result.analise.resumo || '';
                    let detalhada = result.analise.detalhada || '';
                    
                    const resumoLimpo = limparTextoIA(resumo);
                    const detalhadaLimpa = limparTextoIA(detalhada);
                    
                    // Se limparTextoIA retornou um objeto com ambos campos
                    if (typeof resumoLimpo === 'object' && resumoLimpo.resumo) {
                        resumo = resumoLimpo.resumo;
                        detalhada = resumoLimpo.detalhada || detalhada;
                    } else {
                        resumo = typeof resumoLimpo === 'string' ? resumoLimpo : resumo;
                    }
                    if (typeof detalhadaLimpa === 'object' && detalhadaLimpa.detalhada) {
                        detalhada = detalhadaLimpa.detalhada;
                        if (!resumo || resumo.startsWith('```')) resumo = detalhadaLimpa.resumo || resumo;
                    } else {
                        detalhada = typeof detalhadaLimpa === 'string' ? detalhadaLimpa : detalhada;
                    }
                    
                    // Extrair analiseJogos se disponível
                    let analiseJogos = result.analise.analiseJogos || [];
                    
                    console.log('Análise gerada com sucesso!');
                    console.log('Resumo limpo:', resumo.substring(0, 100));
                    console.log('Detalhada limpa:', detalhada.substring(0, 100));
                    console.log('Análises por jogo:', analiseJogos.length);
                    
                    // Extrair resumoCartela se disponível (v2)
                    let resumoCartela = result.analise.resumoCartela || null;
                    let estatisticas = result.analise.estatisticas || null;
                    
                    // Extrair fontes e buscas do Google Search Grounding (v3)
                    let fontes = result.analise.fontes || [];
                    let buscasRealizadas = result.analise.buscasRealizadas || [];
                    
                    console.log('Fontes do Grounding:', fontes.length);
                    console.log('Buscas realizadas:', buscasRealizadas.length);
                    
                    return {
                        resumo: resumo,
                        analiseDetalhada: detalhada,
                        analiseJogos: analiseJogos,
                        resumoCartela: resumoCartela,
                        estatisticas: estatisticas,
                        fontes: fontes,
                        buscasRealizadas: buscasRealizadas
                    };
                    
                } catch (error) {
                    console.error('Erro ao gerar análise:', error);
                    alert('Erro ao gerar análise com IA: ' + error.message + '. Usando análise padrão.');
                    return {
                        resumo: `Concurso ${dados.concurso} - Dados oficiais da Caixa`,
                        analiseDetalhada: 'Análise indisponível no momento.',
                        analiseJogos: []
                    };
                }
            },
            
            gerarPromptProgramacao(dados) {
                const jogosTexto = dados.jogos.map(j => `${j.jogo}. ${j.time1} (mandante) x ${j.time2} (visitante) - ${j.data}`).join('\n');
                
                return `Você é um analista especialista em Loteca e futebol brasileiro.

Analise a programação do concurso ${dados.concurso} da Loteca:

${jogosTexto}

IMPORTANTE:
- O primeiro time é o MANDANTE (joga em casa)
- O segundo time é o VISITANTE (joga fora)
- Use formato: "Time1 x Time2" nas análises

Gere:

1. RESUMO (máximo 120 caracteres):
Frase curta destacando os principais clássicos ou jogos importantes.

2. ANÁLISE DETALHADA (2-3 parágrafos):
- Destaque os principais clássicos e derbies
- Analise os confrontos mais importantes
- Mencione times favoritos e possíveis zebras
- Contexto dos campeonatos

Data: ${dados.dataConcurso || 'N/A'}
Período: ${dados.periodoApostas || 'N/A'}
Realização: ${dados.realizacaoJogos || 'N/A'}

Responda APENAS com o resumo na primeira linha e a análise nas linhas seguintes.`;
            },
            
            gerarPromptResultados(dados) {
                const jogosTexto = dados.jogos.map(j => `${j.jogo}. ${j.time1} (mandante) ${j.placar1} x ${j.placar2} ${j.time2} (visitante)`).join('\n');
                
                // Calcular estatísticas
                let vitoriasMandante = 0, empates = 0, vitoriasVisitante = 0;
                dados.jogos.forEach(j => {
                    const p1 = parseInt(j.placar1);
                    const p2 = parseInt(j.placar2);
                    if (p1 > p2) vitoriasMandante++;
                    else if (p1 === p2) empates++;
                    else vitoriasVisitante++;
                });
                
                return `Você é um analista especialista em Loteca/futebol brasileiro. Analise os resultados do concurso ${dados.concurso} e gere:

1. RESUMO (1 linha, máximo 120 caracteres): Destaque as zebras, placares surpreendentes ou tendências
2. ANÁLISE DETALHADA (2-3 parágrafos): Analise os resultados, zebras, goleadas, empates surpreendentes

Resultados:
${jogosTexto}

Estatísticas:
- Vitórias do mandante: ${vitoriasMandante}
- Empates: ${empates}
- Vitórias do visitante: ${vitoriasVisitante}

Responda APENAS com o resumo na primeira linha e a análise nas linhas seguintes. Seja objetivo e profissional.`;
            }
        };
        
        // CARREGAR DADOS DO FIRESTORE
        const DataLoader = {
            async carregarConcursoAtual() {
                if (!isFirebaseActive) return;
                
                try {
                    const db = firebase.firestore();
                    
                    // Buscar config atual
                    const configDoc = await db.collection('config').doc('atual').get();
                    
                    if (!configDoc.exists) {
                        console.log('Nenhuma configuração encontrada. Usando dados fake.');
                        return;
                    }
                    
                    const config = configDoc.data();
                    const concursoId = config.concursoProgramacao;
                    
                    if (!concursoId) {
                        console.log('Nenhum concurso ativo. Usando dados fake.');
                        return;
                    }
                    
                    // Buscar dados do concurso publicado
                    const concursoDoc = await db.collection('concursos_publicados').doc(concursoId).get();
                    
                    if (!concursoDoc.exists) {
                        console.log('Concurso não encontrado. Usando dados fake.');
                        return;
                    }
                    
                    const concurso = concursoDoc.data();
                    
                    // Carregar analiseJogos se disponível
                    const analiseJogosArr = (concurso.analise && concurso.analise.analiseJogos) ? concurso.analise.analiseJogos : [];
                    
                    // Converter dados do Firestore para formato do Data.games (v2 - com dados avançados)
                    Data.games = concurso.jogos.map((jogo, idx) => {
                        // Buscar análise individual deste jogo
                        const analiseJogo = analiseJogosArr.find(a => a.jogo === (idx + 1)) || analiseJogosArr[idx];
                        const textoAnalise = analiseJogo ? analiseJogo.analise : `${jogo.time1} x ${jogo.time2}`;
                        
                        return {
                            id: jogo.jogo,
                            tour: 'Loteca',
                            date: jogo.data || '-',
                            home: { 
                                name: jogo.time1,
                                short: jogo.time1.split('/')[0].substring(0, 3).toUpperCase()
                            },
                            away: { 
                                name: jogo.time2,
                                short: jogo.time2.split('/')[0].substring(0, 3).toUpperCase()
                            },
                            probs: { h: 33, d: 34, a: 33 },
                            comm: { h: 33, d: 34, a: 33 },
                            analysis: textoAnalise,
                            // Novos campos v2 - Análise Avançada
                            historicoCasa: analiseJogo ? (analiseJogo.historicoCasa || '') : '',
                            historicoFora: analiseJogo ? (analiseJogo.historicoFora || '') : '',
                            consensoMercado: analiseJogo ? (analiseJogo.consensoMercado || '') : '',
                            contextoLocal: analiseJogo ? (analiseJogo.contextoLocal || '') : '',
                            analiseTecnica: analiseJogo ? (analiseJogo.analiseTecnica || '') : '',
                            palpiteIA: analiseJogo ? (analiseJogo.palpite || '') : '',
                            confianca: analiseJogo ? (analiseJogo.confianca || 0) : 0,
                            riscoZebra: analiseJogo ? (analiseJogo.riscoZebra || '') : '',
                            h2h: analiseJogo ? (analiseJogo.h2h || '') : '',
                            fontesUsadas: analiseJogo ? (analiseJogo.fontesUsadas || '') : ''
                        };
                    });
                    
                    Data.loaded = true;
                    Data.concursoAtual = concurso.concurso;
                    
                    // Atualizar análise com informações reais
                    Data.analysis.current.id = parseInt(concurso.concurso);
                    
                    // Formatar estimativa de prêmio (vem dos resultados do concurso anterior)
                    // Por enquanto mantém o padrão, será atualizado quando carregar resultados
                    Data.analysis.current.acc = '1.5M';
                    
                    // Carregar análise gerada pela IA
                    if (concurso.analise) {
                        let r = limparTextoIA(concurso.analise.resumo);
                        let d = limparTextoIA(concurso.analise.detalhada);
                        // Se retornou objeto com ambos campos
                        if (typeof r === 'object' && r.resumo) { d = r.detalhada || d; r = r.resumo; }
                        if (typeof d === 'object' && d.detalhada) { if (!r || typeof r !== 'string') r = d.resumo; d = d.detalhada; }
                        Data.analysis.current.summary = typeof r === 'string' ? r : (concurso.analise.resumo || '');
                        Data.analysis.current.fullAnalysis = typeof d === 'string' ? d : (concurso.analise.detalhada || '');
                        
                        // Carregar resumoCartela (v2)
                        if (concurso.analise.resumoCartela) {
                            Data.analysis.current.resumoCartela = concurso.analise.resumoCartela;
                        }
                    } else {
                        // Fallback se não tiver análise
                        if (concurso.dataConcurso) {
                            Data.analysis.current.summary = `Concurso ${concurso.concurso} (${concurso.dataConcurso})`;
                        } else {
                            Data.analysis.current.summary = `Concurso ${concurso.concurso} - Dados oficiais da Caixa`;
                        }
                        
                        if (concurso.realizacaoJogos) {
                            Data.analysis.current.fullAnalysis = `Concurso ${concurso.concurso} com jogos realizados entre ${concurso.realizacaoJogos}. Período de apostas: ${concurso.periodoApostas || 'Consulte o site da Caixa'}. Confira os confrontos e faça seus palpites!`;
                        }
                    }
                    
                    // Usar período de apostas se disponível
                    if (concurso.periodoApostas) {
                        const partes = concurso.periodoApostas.split('até');
                        Data.analysis.current.openDate = partes[0].trim();
                        Data.analysis.current.closeDate = partes[1] ? 'até ' + partes[1].trim() : concurso.periodoApostas;
                    }
                    
                    console.log(`Concurso ${concurso.concurso} carregado com sucesso!`);
                    
                    // Re-renderizar se já estiver na página
                    if (State.currentRoute === 'home') {
                        Router.render();
                    }
                    
                } catch (error) {
                    console.error('Erro ao carregar concurso:', error);
                }
            },
            
            async carregarConcursoAnterior() {
                try {
                    const db = firebase.firestore();
                    
                    // Buscar config para pegar o concurso de resultados
                    const configDoc = await db.collection('config').doc('atual').get();
                    
                    if (!configDoc.exists) {
                        console.log('Config não encontrada. Usando dados fake para concurso anterior.');
                        return;
                    }
                    
                    const config = configDoc.data();
                    const concursoId = config.concursoResultado;
                    
                    if (!concursoId) {
                        console.log('Nenhum resultado disponível. Usando dados fake.');
                        return;
                    }
                    
                    // Buscar dados do concurso de resultados
                    const concursoDoc = await db.collection('concursos_publicados').doc(concursoId).get();
                    
                    if (!concursoDoc.exists) {
                        console.log('Resultados não encontrados. Usando dados fake.');
                        return;
                    }
                    
                    const concurso = concursoDoc.data();
                    
                    // Atualizar análise do concurso anterior
                    Data.analysis.previous.id = parseInt(concurso.concurso);
                    
                    // Atualizar ganhadores
                    if (concurso.ganhadores14 !== undefined) {
                        Data.analysis.previous.winners = concurso.ganhadores14;
                    }
                    
                    // Atualizar ganhadores de 13 acertos
                    if (concurso.ganhadores13 !== undefined) {
                        Data.analysis.previous.winners13 = concurso.ganhadores13;
                    }
                    
                    // Atualizar acumulação
                    if (concurso.acumulou !== undefined) {
                        Data.analysis.previous.accumulated = concurso.acumulou;
                    }
                    
                    // Salvar jogos do concurso anterior
                    if (concurso.jogos && concurso.jogos.length > 0) {
                        Data.analysis.previous.jogos = concurso.jogos;
                    }
                    
                    // Carregar análise gerada pela IA
                    if (concurso.analise) {
                        let r = limparTextoIA(concurso.analise.resumo);
                        let d = limparTextoIA(concurso.analise.detalhada);
                        // Se retornou objeto com ambos campos
                        if (typeof r === 'object' && r.resumo) { d = r.detalhada || d; r = r.resumo; }
                        if (typeof d === 'object' && d.detalhada) { if (!r || typeof r !== 'string') r = d.resumo; d = d.detalhada; }
                        Data.analysis.previous.summary = typeof r === 'string' ? r : (concurso.analise.resumo || '');
                        Data.analysis.previous.fullAnalysis = typeof d === 'string' ? d : (concurso.analise.detalhada || '');
                        
                        // Carregar análise individual por jogo
                        if (concurso.analise.analiseJogos && Array.isArray(concurso.analise.analiseJogos)) {
                            Data.analysis.previous.analiseJogos = concurso.analise.analiseJogos;
                        }
                    } else {
                        // Fallback se não tiver análise
                        const ganhadores = concurso.ganhadores14 || 0;
                        const acumulou = concurso.acumulou ? 'Acumulou!' : `${ganhadores} ganhador${ganhadores !== 1 ? 'es' : ''}`;
                        Data.analysis.previous.summary = `Concurso ${concurso.concurso} - ${acumulou}`;
                        if (concurso.jogos && concurso.jogos.length > 0) {
                            const totalJogos = concurso.jogos.length;
                            Data.analysis.previous.fullAnalysis = `Concurso ${concurso.concurso} finalizado com ${totalJogos} jogos. Confira os resultados e placares abaixo.`;
                        }
                    }
                    
                    // Atualizar estimativa de prêmio do próximo concurso (vem dos resultados)
                    if (concurso.estimativaPremio) {
                        Data.analysis.current.acc = concurso.estimativaPremio;
                    }
                    
                    console.log(`Resultados do concurso ${concurso.concurso} carregados com sucesso!`);
                    
                    // Re-renderizar a homepage para mostrar dados atualizados
                    if (State.currentRoute === 'home') {
                        Router.render();
                    }
                    
                } catch (error) {
                    console.error('Erro ao carregar concurso anterior:', error);
                }
            },

            async carregarMercado(forceRefresh = false) {
                if (!isFirebaseActive) return;
                try {
                    const db = firebase.firestore();
                    const configDoc = await db.collection('config').doc('atual').get();
                    if (!configDoc.exists) return;
                    const concursoId = configDoc.data().concursoProgramacao;
                    if (!concursoId) return;

                    // Tentar carregar do Firestore primeiro (cache)
                    if (!forceRefresh) {
                        const mercadoDoc = await db.collection('mercado').doc(concursoId).get();
                        if (mercadoDoc.exists) {
                            const data = mercadoDoc.data();
                            Data.mercado = data;
                            Data._mercadoLoading = false;
                            console.log(`Mercado carregado do Firestore: ${(data.destaque?.length||0) + (data.rumores?.length||0) + (data.lesoes?.length||0)} noticias`);
                            if (State.currentRoute === 'market') Router.render();
                            return;
                        }
                    }

                    // Se não tem cache ou forceRefresh, chamar a Cloud Function
                    Data._mercadoLoading = true;
                    if (State.currentRoute === 'market') Router.render();

                    const user = firebase.auth().currentUser;
                    if (!user) {
                        console.log('Usuario nao autenticado. Mercado nao pode ser buscado via API.');
                        Data._mercadoLoading = false;
                        if (State.currentRoute === 'market') Router.render();
                        return;
                    }

                    const token = await user.getIdToken();
                    const response = await fetch('https://us-central1-loteca-pro-mateus-1767825041.cloudfunctions.net/buscarMercado', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({ concurso: concursoId, forceRefresh: forceRefresh })
                    });

                    const result = await response.json();
                    if (result.success && result.mercado) {
                        Data.mercado = result.mercado;
                        console.log(`Mercado atualizado via API: ${result.mercado.totalNoticias || 0} noticias (cache=${result.fromCache})`);
                    }
                    Data._mercadoLoading = false;
                    if (State.currentRoute === 'market') Router.render();
                } catch (error) {
                    console.error('Erro ao carregar mercado:', error);
                    Data._mercadoLoading = false;
                    if (State.currentRoute === 'market') Router.render();
                }
            }
        };

        // MERCADO ACTIONS
        // MONTADOR ACTIONS
        const MontadorActions = {
            _refresh: () => {
                const container = document.getElementById('montador-content');
                if (container) container.innerHTML = Views.MontadorContent();
            },
            toggle: (gameId, type) => {
                if (!State.montagem) State.montagem = {};
                const sel = State.montagem[gameId] || [];
                const idx = sel.indexOf(type);
                if (idx >= 0) {
                    sel.splice(idx, 1);
                } else {
                    sel.push(type);
                }
                State.montagem[gameId] = sel;
                MontadorActions._refresh();
            },
            limpar: () => {
                State.montagem = {};
                MontadorActions._refresh();
            },
            compartilhar: () => {
                const montagem = State.montagem || {};
                const jogos = Data.games;
                let texto = '🎯 LOTECA PRO - Concurso #' + Data.analysis.current.id + '\n';
                texto += '━━━━━━━━━━━━━━━━━━━━━\n';
                jogos.forEach(g => {
                    const sel = montagem[g.id] || [];
                    const palpite = sel.map(s => s==='h'?'1':(s==='d'?'X':'2')).join('/');
                    const tipo = sel.length === 3 ? ' (T)' : (sel.length === 2 ? ' (D)' : '');
                    texto += g.id + '. ' + g.home.name + ' x ' + g.away.name + ' → ' + palpite + tipo + '\n';
                });
                let numApostas = 1;
                jogos.forEach(g => { const sel = montagem[g.id] || []; if (sel.length >= 1) numApostas *= sel.length; });
                texto += '━━━━━━━━━━━━━━━━━━━━━\n';
                texto += '💰 Valor: R$ ' + (numApostas * 2).toLocaleString('pt-BR', {minimumFractionDigits: 2}) + ' (' + numApostas + ' apostas)\n';
                texto += '🌐 loteca-pro-mateus-1767825041.web.app';
                
                if (navigator.share) {
                    navigator.share({ title: 'Minha Aposta Loteca', text: texto }).catch(() => {});
                } else {
                    navigator.clipboard.writeText(texto).then(() => alert('Aposta copiada para a area de transferencia!')).catch(() => alert(texto));
                }
            },
            imprimir: () => {
                const montagem = State.montagem || {};
                const jogos = Data.games;
                let numApostas = 1;
                let numDuplos = 0, numTriplos = 0;
                jogos.forEach(g => { 
                    const sel = montagem[g.id] || []; 
                    if (sel.length >= 1) numApostas *= sel.length;
                    if (sel.length === 2) numDuplos++;
                    if (sel.length === 3) numTriplos++;
                });
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Loteca Pro - Concurso #' + Data.analysis.current.id + '</title><style>');
                printWindow.document.write('body{font-family:Arial,sans-serif;padding:20px;max-width:500px;margin:0 auto}');
                printWindow.document.write('.header{text-align:center;border-bottom:3px solid #4ade80;padding-bottom:15px;margin-bottom:15px}');
                printWindow.document.write('.header h1{color:#0f172a;font-size:24px;margin:0}');
                printWindow.document.write('.header h2{color:#4ade80;font-size:16px;margin:5px 0}');
                printWindow.document.write('.header p{color:#666;font-size:12px}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;margin:10px 0}');
                printWindow.document.write('th{background:#0f172a;color:white;padding:8px;font-size:11px;text-align:center}');
                printWindow.document.write('td{padding:6px 8px;border-bottom:1px solid #eee;font-size:12px}');
                printWindow.document.write('.palpite{font-weight:bold;text-align:center;font-size:14px}');
                printWindow.document.write('.sel-1{color:#22c55e}.sel-X{color:#eab308}.sel-2{color:#ef4444}');
                printWindow.document.write('.duplo{background:#fef3c7}.triplo{background:#ede9fe}');
                printWindow.document.write('.footer{text-align:center;margin-top:15px;padding-top:15px;border-top:2px solid #4ade80}');
                printWindow.document.write('.footer .valor{font-size:28px;font-weight:900;color:#0f172a}');
                printWindow.document.write('.footer .site{color:#4ade80;font-size:14px;font-weight:bold;margin-top:10px}');
                printWindow.document.write('.info{display:flex;justify-content:space-around;margin:10px 0;font-size:12px}');
                printWindow.document.write('.info div{text-align:center}.info .num{font-size:20px;font-weight:900}');
                printWindow.document.write('</style></head><body>');
                printWindow.document.write('<div class="header"><img src="/logo-full.png" style="max-height:50px;margin:0 auto 10px;display:block" alt="Loteca Pro"><h2>Concurso #' + Data.analysis.current.id + '</h2><p>A Casa do Lotequeiro Profissional</p></div>');
                printWindow.document.write('<div class="info"><div><div class="num">' + numDuplos + '</div>Duplos</div><div><div class="num">' + numTriplos + '</div>Triplos</div><div><div class="num">' + numApostas + '</div>Apostas</div></div>');
                printWindow.document.write('<table><tr><th>JG</th><th>MANDANTE</th><th>1</th><th>X</th><th>2</th><th>VISITANTE</th></tr>');
                jogos.forEach(g => {
                    const sel = montagem[g.id] || [];
                    const rowClass = sel.length === 3 ? ' class="triplo"' : (sel.length === 2 ? ' class="duplo"' : '');
                    printWindow.document.write('<tr' + rowClass + '><td style="text-align:center;font-weight:bold">' + g.id + '</td><td style="text-align:right">' + g.home.name + '</td>');
                    ['h','d','a'].forEach(t => {
                        const label = t==='h'?'1':(t==='d'?'X':'2');
                        const isSel = sel.includes(t);
                        printWindow.document.write('<td class="palpite sel-' + label + '">' + (isSel ? label : '-') + '</td>');
                    });
                    printWindow.document.write('<td>' + g.away.name + '</td></tr>');
                });
                printWindow.document.write('</table>');
                printWindow.document.write('<div class="footer"><div class="valor">R$ ' + (numApostas * 2).toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</div><p style="color:#666;font-size:11px">' + numApostas + ' apostas × R$ 2,00</p><div class="site">loteca-pro-mateus-1767825041.web.app</div><p style="color:#999;font-size:10px">Gerado em ' + new Date().toLocaleString('pt-BR') + '</p></div>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 500);
            }
        };

        // CARTOLA ACTIONS
        const CartolaActions = {
            _refresh: () => {
                const container = document.getElementById('cartola-content');
                if (container) container.innerHTML = Views.CartolaContent();
            },
            async carregar() {
                if (Data._cartolaLoading) return;
                Data._cartolaLoading = true;
                const container = document.getElementById('cartola-content');
                if (container) container.innerHTML = Views.CartolaContent();
                try {
                    const proxyUrl = 'https://us-central1-loteca-pro-mateus-1767825041.cloudfunctions.net/cartolaProxy';
                    const [pontuadosRes, mercadoRes, partidasRes] = await Promise.all([
                        fetch(proxyUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({endpoint:'atletas/pontuados'}) }).catch(() => null),
                        fetch(proxyUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({endpoint:'mercado/status'}) }).catch(() => null),
                        fetch(proxyUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({endpoint:'partidas'}) }).catch(() => null)
                    ]);
                    
                    let cd = { rodada: '-', status: 'Indisponivel', destaques: [], todosJogadores: [], jogos: [], clubesMap: {}, mediaGeral: '-', maiorPontuacao: '-', jogosFinalizados: 0, totalJogos: 10, timesEscalados: 0 };
                    
                    if (mercadoRes && mercadoRes.ok) {
                        const mr = (await mercadoRes.json()).data || {};
                        cd.rodada = mr.rodada_atual || '-';
                        cd.status = mr.status_mercado === 1 ? 'Mercado Aberto' : (mr.status_mercado === 2 ? 'Mercado Fechado' : 'Rodada em andamento');
                        cd.timesEscalados = mr.times_escalados || 0;
                        cd.bolaRolando = mr.bola_rolando || false;
                    }
                    
                    if (pontuadosRes && pontuadosRes.ok) {
                        const pr = (await pontuadosRes.json()).data || {};
                        const clubes = pr.clubes || {};
                        const posicoes = pr.posicoes || {};
                        const atletas = pr.atletas || {};
                        
                        // Mapear clubes com escudos
                        cd.clubesMap = {};
                        Object.values(clubes).forEach(c => {
                            cd.clubesMap[c.id] = {
                                id: c.id, nome: c.nome, abreviacao: c.abreviacao,
                                nome_fantasia: c.nome_fantasia || c.apelido || c.nome,
                                escudo: c.escudos ? c.escudos['30x30'] : ''
                            };
                        });
                        
                        // Todos os jogadores
                        cd.todosJogadores = Object.values(atletas).map(a => ({
                            nome: a.apelido,
                            pontos: a.pontuacao ? parseFloat(a.pontuacao.toFixed(1)) : 0,
                            clube: clubes[a.clube_id] ? clubes[a.clube_id].nome : '?',
                            clube_id: a.clube_id,
                            posicao: posicoes[a.posicao_id] ? posicoes[a.posicao_id].nome : '?',
                            posicao_abrev: posicoes[a.posicao_id] ? posicoes[a.posicao_id].abreviacao : '?',
                            foto: a.foto ? a.foto.replace('FORMATO', '60x60') : '',
                            scout: a.scout || {}
                        })).sort((a, b) => b.pontos - a.pontos);
                        
                        cd.destaques = cd.todosJogadores.slice(0, 10);
                        if (cd.todosJogadores.length > 0) {
                            cd.maiorPontuacao = cd.todosJogadores[0].pontos.toFixed(1);
                            const total = cd.todosJogadores.reduce((s, j) => s + j.pontos, 0);
                            cd.mediaGeral = (total / cd.todosJogadores.length).toFixed(1);
                        }
                    }
                    
                    if (partidasRes && partidasRes.ok) {
                        const ptr = (await partidasRes.json()).data || {};
                        const clubes = ptr.clubes || {};
                        cd.jogos = (ptr.partidas || []).map(p => {
                            const cm = clubes[p.clube_casa_id] || {};
                            const cv = clubes[p.clube_visitante_id] || {};
                            const dt = p.partida_data ? new Date(p.partida_data) : null;
                            return {
                                mandante: cm.nome_fantasia || cm.nome || '?',
                                visitante: cv.nome_fantasia || cv.nome || '?',
                                escudoMandante: cm.escudos ? cm.escudos['30x30'] : '',
                                escudoVisitante: cv.escudos ? cv.escudos['30x30'] : '',
                                placarMandante: p.placar_oficial_mandante,
                                placarVisitante: p.placar_oficial_visitante,
                                local: p.local || '',
                                horario: dt ? dt.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}) : '',
                                status: p.placar_oficial_mandante !== null ? 'Encerrado' : (p.valida === false ? 'Cancelado' : 'Agendado')
                            };
                        });
                        cd.totalJogos = cd.jogos.length;
                        cd.jogosFinalizados = cd.jogos.filter(j => j.status === 'Encerrado').length;
                        
                        // Atualizar clubesMap com dados das partidas se não veio dos pontuados
                        if (Object.keys(cd.clubesMap).length === 0) {
                            Object.values(clubes).forEach(c => {
                                cd.clubesMap[c.id] = {
                                    id: c.id, nome: c.nome, abreviacao: c.abreviacao,
                                    nome_fantasia: c.nome_fantasia || c.apelido || c.nome,
                                    escudo: c.escudos ? c.escudos['30x30'] : ''
                                };
                            });
                        }
                    }
                    
                    Data._cartolaData = cd;
                    
                    // Auto-refresh se bola rolando
                    if (cd.bolaRolando) {
                        clearTimeout(Data._cartolaAutoRefresh);
                        Data._cartolaAutoRefresh = setTimeout(() => {
                            Data._cartolaLoading = false;
                            CartolaActions.carregar();
                        }, 60000);
                    }
                    
                    // Carregar meus times automaticamente
                    const meusTimesIds = JSON.parse(localStorage.getItem('cartola_meus_times') || '[]');
                    if (meusTimesIds.length > 0) CartolaActions.atualizarMeusTimes();
                    
                } catch (error) {
                    console.error('Erro ao carregar Cartola:', error);
                    Data._cartolaData = { rodada: '-', status: 'Erro ao carregar.', destaques: [], todosJogadores: [], jogos: [], clubesMap: {}, mediaGeral: '-', maiorPontuacao: '-', jogosFinalizados: 0, totalJogos: 0 };
                }
                Data._cartolaLoading = false;
                if (State.currentRoute === 'cartola') CartolaActions._refresh();
            },
            async adicionarTime() {
                const input = document.getElementById('cartola-add-time');
                if (!input) return;
                const slug = input.value.trim().toLowerCase().replace(/\s+/g, '-');
                if (!slug) return;
                
                Data._cartolaTimeLoading = true;
                CartolaActions._refresh();
                
                try {
                    const proxyUrl = 'https://us-central1-loteca-pro-mateus-1767825041.cloudfunctions.net/cartolaProxy';
                    const res = await fetch(proxyUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({endpoint: 'time/slug/' + slug}) });
                    if (!res.ok) throw new Error('Time nao encontrado');
                    const result = await res.json();
                    if (!result.success || !result.data) throw new Error('Time nao encontrado');
                    
                    const timeData = result.data;
                    const meusTimesIds = JSON.parse(localStorage.getItem('cartola_meus_times') || '[]');
                    if (!meusTimesIds.includes(slug)) {
                        meusTimesIds.push(slug);
                        localStorage.setItem('cartola_meus_times', JSON.stringify(meusTimesIds));
                    }
                    
                    if (!Data._cartolaMeusTimes) Data._cartolaMeusTimes = {};
                    const time = timeData.time || {};
                    Data._cartolaMeusTimes[slug] = {
                        slug: slug,
                        nome: time.nome || slug,
                        nome_cartoleiro: time.nome_cartoleiro || '',
                        url_escudo: time.url_escudo_png || time.url_escudo_svg || '',
                        pontos_rodada: time.pontos_rodada || 0,
                        pontos_total: time.pontos_campeonato || 0,
                        atletas: (timeData.atletas || []).map(a => ({
                            apelido: a.apelido,
                            pontos: a.pontos_num !== undefined ? a.pontos_num : (a.pontuacao || 0)
                        }))
                    };
                    
                    input.value = '';
                } catch (error) {
                    alert('Time nao encontrado. Verifique o slug (nome na URL do Cartola).');
                }
                Data._cartolaTimeLoading = false;
                CartolaActions._refresh();
            },
            removerTime(slug) {
                let meusTimesIds = JSON.parse(localStorage.getItem('cartola_meus_times') || '[]');
                meusTimesIds = meusTimesIds.filter(s => s !== slug);
                localStorage.setItem('cartola_meus_times', JSON.stringify(meusTimesIds));
                if (Data._cartolaMeusTimes) delete Data._cartolaMeusTimes[slug];
                CartolaActions._refresh();
            },
            async atualizarMeusTimes() {
                const meusTimesIds = JSON.parse(localStorage.getItem('cartola_meus_times') || '[]');
                if (meusTimesIds.length === 0) return;
                const proxyUrl = 'https://us-central1-loteca-pro-mateus-1767825041.cloudfunctions.net/cartolaProxy';
                if (!Data._cartolaMeusTimes) Data._cartolaMeusTimes = {};
                
                await Promise.all(meusTimesIds.map(async slug => {
                    try {
                        const res = await fetch(proxyUrl, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({endpoint: 'time/slug/' + slug}) });
                        if (!res.ok) return;
                        const result = await res.json();
                        if (!result.success || !result.data) return;
                        const timeData = result.data;
                        const time = timeData.time || {};
                        Data._cartolaMeusTimes[slug] = {
                            slug: slug,
                            nome: time.nome || slug,
                            nome_cartoleiro: time.nome_cartoleiro || '',
                            url_escudo: time.url_escudo_png || time.url_escudo_svg || '',
                            pontos_rodada: time.pontos_rodada || 0,
                            pontos_total: time.pontos_campeonato || 0,
                            atletas: (timeData.atletas || []).map(a => ({
                                apelido: a.apelido,
                                pontos: a.pontos_num !== undefined ? a.pontos_num : (a.pontuacao || 0)
                            }))
                        };
                    } catch(e) { console.log('Erro ao buscar time ' + slug, e); }
                }));
                
                if (State.currentRoute === 'cartola') CartolaActions._refresh();
            }
        };

                const MercadoActions = {
            _loaded: false,
            async carregarSeNecessario() {
                // Carregar do Firestore se ainda não carregou
                if (!this._loaded && (!Data.mercado || !Data.mercado.concurso)) {
                    this._loaded = true;
                    await DataLoader.carregarMercado(false);
                }
            },
            async atualizar(forceRefresh = false) {
                const btn = document.getElementById('btn-atualizar-mercado');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Buscando...';
                }
                this._loaded = true;
                await DataLoader.carregarMercado(forceRefresh);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>Atualizar';
                }
            }
        };

        // ADMIN ACTIONS
        const AdminActions = {
            async processar(tipo) {
                const textarea = document.getElementById(`html-${tipo}`);
                const jsonContent = textarea.value;
                
                if (!jsonContent.trim()) {
                    alert('Por favor, cole os dados primeiro!');
                    return;
                }
                
                try {
                    // Parse JSON
                    const dados = JSON.parse(jsonContent);
                    
                    // Validar estrutura
                    if (!dados.tipo || !dados.jogos || !Array.isArray(dados.jogos)) {
                        throw new Error('Formato inválido! Use o bookmarklet para copiar os dados.');
                    }
                    
                    // Validar se tem jogos
                    if (dados.jogos.length === 0) {
                        throw new Error('Nenhum jogo encontrado! Verifique se está na página correta da Caixa.');
                    }
                    
                    // Validar se tem concurso
                    if (!dados.concurso) {
                        throw new Error('Número do concurso não encontrado! Verifique se está na página correta da Caixa.');
                    }
                    
                    // Validar se os jogos têm os campos necessários
                    const primeiroJogo = dados.jogos[0];
                    if (!primeiroJogo.time1 || !primeiroJogo.time2) {
                        throw new Error('Dados incompletos! Os times não foram extraídos corretamente. Tente novamente.');
                    }
                    
                    // Verificar autenticação
                    if (!firebase.auth().currentUser) {
                        throw new Error('Você precisa estar logado!');
                    }
                    
                    // Preparar documento para o Firestore
                    const docData = {
                        concurso: dados.concurso,
                        tipo: dados.tipo,
                        jogos: dados.jogos,
                        atualizado: firebase.firestore.FieldValue.serverTimestamp(),
                        atualizadoPor: firebase.auth().currentUser.email
                    };
                    
                    // Adicionar campos específicos de programação
                    if (dados.tipo === 'programacao') {
                        if (dados.dataConcurso) docData.dataConcurso = dados.dataConcurso;
                        if (dados.periodoApostas) docData.periodoApostas = dados.periodoApostas;
                        if (dados.realizacaoJogos) docData.realizacaoJogos = dados.realizacaoJogos;
                    }
                    
                    // Adicionar campos específicos de resultados
                    if (dados.tipo === 'resultados' || dados.tipo === 'resultado') {
                        if (dados.estimativaPremio) docData.estimativaPremio = dados.estimativaPremio;
                        if (dados.ganhadores14 !== undefined) docData.ganhadores14 = dados.ganhadores14;
                        if (dados.ganhadores13) docData.ganhadores13 = dados.ganhadores13;
                        if (dados.acumulou !== undefined) docData.acumulou = dados.acumulou;
                    }
                    
                    // Salvar no Firestore como rascunho
                    const db = firebase.firestore();
                    await db.collection('concursos').doc(dados.concurso).set(docData, { merge: true });
                    
                    // Armazenar dados para preview
                    window.dadosPreview = dados;
                    
                    // Mostrar preview
                    AdminActions.mostrarPreview(dados);
                    
                    // Limpar textarea
                    textarea.value = '';
                    
                    // Feedback de sucesso
                    const feedback = document.getElementById('admin-feedback');
                    feedback.textContent = `✓ Dados salvos! Confira o preview abaixo e clique em PUBLICAR.`;
                    feedback.classList.remove('hidden');
                    feedback.classList.remove('bg-red-500/20', 'border-red-500/50', 'text-red-400');
                    feedback.classList.add('bg-green-500/20', 'border-green-500/50', 'text-green-400');
                    setTimeout(() => feedback.classList.add('hidden'), 5000);
                    
                } catch (error) {
                    const feedback = document.getElementById('admin-feedback');
                    feedback.textContent = `✗ Erro: ${error.message}`;
                    feedback.classList.remove('hidden');
                    feedback.classList.remove('bg-green-500/20', 'border-green-500/50', 'text-green-400');
                    feedback.classList.add('bg-red-500/20', 'border-red-500/50', 'text-red-400');
                    setTimeout(() => feedback.classList.add('hidden'), 5000);
                }
            },
            
            async carregarAlertas() {
                try {
                    const idToken = await firebase.auth().currentUser.getIdToken();
                    const response = await fetch('https://us-central1-loteca-pro-mateus-1767825041.cloudfunctions.net/buscarAlertas', {
                        headers: { 'Authorization': `Bearer ${idToken}` }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.alertas.length > 0) {
                        const container = document.getElementById('alertas-list');
                        container.innerHTML = result.alertas.map(a => `
                            <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                                <p class="text-yellow-400 font-bold text-sm">${a.assunto}</p>
                                <p class="text-slate-300 text-xs mt-1">${a.mensagem}</p>
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('alertas-list').innerHTML = '<p class="text-sm text-slate-500">Nenhum alerta novo</p>';
                    }
                } catch (error) {
                    console.error('Erro ao carregar alertas:', error);
                }
            },
            
            mostrarPreview(dados) {
                const container = document.getElementById('preview-container');
                const content = document.getElementById('preview-content');
                
                // Gerar HTML do preview
                let html = `
                    <div class="bg-black/30 p-4 rounded-lg mb-4">
                        <h4 class="text-white font-bold text-lg mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            Concurso ${dados.concurso} - ${dados.tipo === 'programacao' ? 'Programação' : 'Resultados'}
                        </h4>
                        <p class="text-slate-400 text-sm">Total de jogos: ${dados.jogos.length}</p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-white/10">
                                    <th class="text-left py-2 px-3 text-slate-400 font-medium">Jogo</th>
                                    <th class="text-left py-2 px-3 text-slate-400 font-medium">Time 1</th>
                                    ${dados.tipo === 'resultado' ? '<th class="text-center py-2 px-2 text-slate-400 font-medium">Placar</th>' : ''}
                                    <th class="text-left py-2 px-3 text-slate-400 font-medium">Time 2</th>
                                    <th class="text-left py-2 px-3 text-slate-400 font-medium">Data</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                dados.jogos.forEach(jogo => {
                    html += `
                        <tr class="border-b border-white/5 hover:bg-white/5">
                            <td class="py-3 px-3 text-white font-bold">${jogo.jogo}</td>
                            <td class="py-3 px-3 text-white">${jogo.time1}</td>
                            ${dados.tipo === 'resultado' ? `<td class="py-3 px-2 text-center text-app-primary font-bold">${jogo.placar1} x ${jogo.placar2}</td>` : ''}
                            <td class="py-3 px-3 text-white">${jogo.time2}</td>
                            <td class="py-3 px-3 text-slate-400">${jogo.data || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                content.innerHTML = html;
                container.classList.remove('hidden');
                
                // Scroll para o preview
                setTimeout(() => {
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            },
            
            async publicar() {
                if (!window.dadosPreview) {
                    alert('Nenhum dado para publicar!');
                    return;
                }
                
                const dados = window.dadosPreview;
                const db = firebase.firestore();
                const tipoLabel = dados.tipo === 'programacao' ? 'Programacao' : 'Resultados';
                const nJogos = (dados.jogos || []).length;

                // Definir etapas do progresso
                const steps = [
                    { icon: 'fa-clipboard-check', label: 'Validando dados', sublabel: `${nJogos} jogos do concurso ${dados.concurso}` },
                    { icon: 'fa-robot', label: 'Gerando analise com IA', sublabel: 'Conectando ao Gemini...' },
                    { icon: 'fa-database', label: 'Salvando no banco de dados', sublabel: 'Aguardando...' },
                    { icon: 'fa-globe', label: 'Publicando no site', sublabel: 'Aguardando...' },
                    { icon: 'fa-exchange-alt', label: 'Buscando noticias de mercado', sublabel: 'Aguardando...' }
                ];

                ProgressOverlay.show(`Publicando ${tipoLabel} #${dados.concurso}`, steps);

                try {
                    // ETAPA 1: Validar dados
                    await new Promise(r => setTimeout(r, 500));
                    ProgressOverlay.completeStep(0);

                    // ETAPA 2: Gerar analise com IA (com retry)
                    ProgressOverlay.activateStep(1, 'Enviando jogos para analise...');
                    let analise = null;
                    let tentativas = 0;
                    const maxTentativas = 3;

                    while (tentativas < maxTentativas) {
                        tentativas++;
                        try {
                            ProgressOverlay.updateSublabel(1, `Tentativa ${tentativas}/${maxTentativas} - Analisando ${nJogos} jogos...`);
                            analise = await AIAnalyzer.analisarConcurso(dados);

                            if (!analise.resumo.includes('Dados oficiais da Caixa')) {
                                ProgressOverlay.updateSublabel(1, `Analise gerada com sucesso!`);
                                break;
                            }

                            console.log(`Tentativa ${tentativas} retornou fallback, tentando novamente...`);
                            if (tentativas < maxTentativas) {
                                ProgressOverlay.updateSublabel(1, `Tentativa ${tentativas} incompleta. Aguardando 5s para tentar novamente...`);
                                await new Promise(r => setTimeout(r, 5000));
                            }
                        } catch (retryError) {
                            console.error(`Tentativa ${tentativas} falhou:`, retryError);
                            if (tentativas < maxTentativas) {
                                ProgressOverlay.updateSublabel(1, `Tentativa ${tentativas} falhou. Aguardando 5s...`);
                                await new Promise(r => setTimeout(r, 5000));
                            }
                        }
                    }

                    if (!analise) {
                        analise = {
                            resumo: `Concurso ${dados.concurso} - Dados oficiais da Caixa`,
                            analiseDetalhada: 'Analise indisponivel no momento. Use o botao Regenerar Analise IA para tentar novamente.',
                            analiseJogos: []
                        };
                    }

                    const analiseOk = !analise.resumo.includes('Dados oficiais da Caixa');
                    if (analiseOk) {
                        ProgressOverlay.completeStep(1);
                    } else {
                        ProgressOverlay.errorStep(1, 'IA indisponivel - publicando sem analise avancada');
                    }

                    // ETAPA 3: Salvar no Firestore
                    ProgressOverlay.activateStep(2, 'Gravando dados no Firestore...');

                    const docData = {
                        concurso: dados.concurso,
                        tipo: dados.tipo,
                        jogos: dados.jogos,
                        publicado: firebase.firestore.FieldValue.serverTimestamp(),
                        publicadoPor: firebase.auth().currentUser.email,
                        status: 'publicado',
                        analise: {
                            resumo: analise.resumo,
                            detalhada: analise.analiseDetalhada,
                            analiseJogos: analise.analiseJogos || [],
                            resumoCartela: analise.resumoCartela || null,
                            estatisticas: analise.estatisticas || null,
                            fontes: analise.fontes || [],
                            buscasRealizadas: analise.buscasRealizadas || [],
                            geradaEm: new Date().toISOString(),
                            versao: 'v4'
                        }
                    };

                    if (dados.tipo === 'programacao') {
                        if (dados.dataConcurso) docData.dataConcurso = dados.dataConcurso;
                        if (dados.periodoApostas) docData.periodoApostas = dados.periodoApostas;
                        if (dados.realizacaoJogos) docData.realizacaoJogos = dados.realizacaoJogos;
                    }

                    if (dados.tipo === 'resultados' || dados.tipo === 'resultado') {
                        if (dados.estimativaPremio) docData.estimativaPremio = dados.estimativaPremio;
                        if (dados.ganhadores14 !== undefined) docData.ganhadores14 = dados.ganhadores14;
                        if (dados.ganhadores13) docData.ganhadores13 = dados.ganhadores13;
                        if (dados.acumulou !== undefined) docData.acumulou = dados.acumulou;
                    }

                    await db.collection('concursos_publicados').doc(dados.concurso).set(docData);
                    ProgressOverlay.updateSublabel(2, 'Dados salvos com sucesso!');
                    ProgressOverlay.completeStep(2);

                    // ETAPA 4: Atualizar config e publicar
                    ProgressOverlay.activateStep(3, 'Atualizando configuracao do site...');

                    const configUpdate = {};
                    if (dados.tipo === 'programacao') {
                        configUpdate.concursoProgramacao = dados.concurso;
                    } else {
                        configUpdate.concursoResultado = dados.concurso;
                    }
                    configUpdate.ultimaAtualizacao = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('config').doc('atual').set(configUpdate, { merge: true });

                    ProgressOverlay.completeStep(3);
                    // ETAPA 5: Buscar noticias de mercado (apenas para programacao)
                    if (dados.tipo === 'programacao') {
                        ProgressOverlay.activateStep(4, 'Buscando transferencias, lesoes e rumores...');
                        try {
                            const tokenMercado = await firebase.auth().currentUser.getIdToken();
                            const mercadoResponse = await fetch('https://us-central1-loteca-pro-mateus-1767825041.cloudfunctions.net/buscarMercado', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + tokenMercado },
                                body: JSON.stringify({ concurso: dados.concurso, jogos: dados.jogos, forceRefresh: true })
                            });
                            const mercadoResult = await mercadoResponse.json();
                            if (mercadoResult.success && mercadoResult.mercado) {
                                Data.mercado = mercadoResult.mercado;
                                MercadoActions._loaded = true;
                                const total = mercadoResult.mercado.totalNoticias || 0;
                                ProgressOverlay.updateSublabel(4, `${total} noticias encontradas!`);
                                ProgressOverlay.completeStep(4);
                            } else {
                                ProgressOverlay.errorStep(4, 'Noticias indisponiveis - tente atualizar depois');
                            }
                        } catch (mercadoError) {
                            console.error('Erro ao buscar mercado:', mercadoError);
                            ProgressOverlay.errorStep(4, 'Erro na busca - tente atualizar depois no Mercado');
                        }
                    } else {
                        ProgressOverlay.completeStep(4);
                    }
                    // CONCLUIDO
                    if (analiseOk) {
                        ProgressOverlay.finish(true, `Concurso ${dados.concurso} publicado com analise IA completa!`);
                    } else {
                        ProgressOverlay.finish(true, `Concurso ${dados.concurso} publicado! Analise IA parcial - use Regenerar para completar.`);
                    }

                    AdminActions.cancelarPreview();
                    window.dadosPreview = null;

                } catch (error) {
                    console.error('Erro ao publicar:', error);
                    ProgressOverlay.errorStep(ProgressOverlay._currentStep, error.message);
                    ProgressOverlay.finish(false, `Erro ao publicar: ${error.message}`);
                }
            },
            
            cancelarPreview() {
                document.getElementById('preview-container').classList.add('hidden');
                window.dadosPreview = null;
            },
            
            async carregarConcursosParaRegen() {
                try {
                    const db = firebase.firestore();
                    const snapshot = await db.collection('concursos_publicados').orderBy('concurso', 'desc').limit(10).get();
                    const select = document.getElementById('regen-concurso');
                    if (!select) return;
                    select.innerHTML = '<option value="">Selecione o concurso...</option>';
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const tipo = data.tipo === 'programacao' ? 'Programação' : 'Resultados';
                        const temAnalise = data.analise && data.analise.resumo && !data.analise.resumo.includes('Dados oficiais');
                        const status = temAnalise ? '✅' : '⚠️';
                        select.innerHTML += `<option value="${doc.id}">${status} #${doc.id} - ${tipo}</option>`;
                    });
                } catch (error) {
                    console.error('Erro ao carregar concursos:', error);
                }
            },
            
            async regenerarAnalise() {
                const select = document.getElementById('regen-concurso');
                const concursoId = select ? select.value : '';
                
                if (!concursoId) {
                    alert('Selecione um concurso!');
                    return;
                }

                const steps = [
                    { icon: 'fa-search', label: 'Buscando dados do concurso', sublabel: `Concurso ${concursoId}` },
                    { icon: 'fa-robot', label: 'Gerando analise com IA', sublabel: 'Conectando ao Gemini...' },
                    { icon: 'fa-database', label: 'Atualizando banco de dados', sublabel: 'Aguardando...' },
                    { icon: 'fa-sync-alt', label: 'Recarregando dados do site', sublabel: 'Aguardando...' }
                ];

                ProgressOverlay.show(`Regenerando Analise #${concursoId}`, steps);

                try {
                    // ETAPA 1: Buscar dados
                    const db = firebase.firestore();
                    const doc = await db.collection('concursos_publicados').doc(concursoId).get();
                    if (!doc.exists) throw new Error('Concurso nao encontrado!');
                    const dados = doc.data();
                    const nJogos = (dados.jogos || []).length;
                    ProgressOverlay.updateSublabel(0, `${nJogos} jogos encontrados`);
                    ProgressOverlay.completeStep(0);

                    // ETAPA 2: Gerar analise
                    ProgressOverlay.activateStep(1, `Analisando ${nJogos} jogos com Gemini...`);
                    const analise = await AIAnalyzer.analisarConcurso(dados);

                    if (analise.resumo.includes('Dados oficiais da Caixa')) {
                        ProgressOverlay.errorStep(1, 'IA nao conseguiu gerar a analise');
                        throw new Error('A IA nao conseguiu gerar a analise. Tente novamente em alguns minutos.');
                    }
                    ProgressOverlay.updateSublabel(1, 'Analise completa gerada!');
                    ProgressOverlay.completeStep(1);

                    // ETAPA 3: Atualizar Firestore
                    ProgressOverlay.activateStep(2, 'Salvando analise no Firestore...');
                    await db.collection('concursos_publicados').doc(concursoId).update({
                        'analise.resumo': analise.resumo,
                        'analise.detalhada': analise.analiseDetalhada,
                        'analise.analiseJogos': analise.analiseJogos || [],
                        'analise.resumoCartela': analise.resumoCartela || null,
                        'analise.estatisticas': analise.estatisticas || null,
                        'analise.fontes': analise.fontes || [],
                        'analise.buscasRealizadas': analise.buscasRealizadas || [],
                        'analise.geradaEm': new Date().toISOString(),
                        'analise.modelo': 'gemini-2.0-flash',
                        'analise.versao': 'v4'
                    });
                    ProgressOverlay.updateSublabel(2, 'Dados atualizados!');
                    ProgressOverlay.completeStep(2);

                    // ETAPA 4: Recarregar dados
                    ProgressOverlay.activateStep(3, 'Recarregando pagina...');
                    await DataLoader.carregarConcursoAtual();
                    await DataLoader.carregarConcursoAnterior();
                    AdminActions.carregarConcursosParaRegen();
                    ProgressOverlay.completeStep(3);

                    ProgressOverlay.finish(true, `Analise do concurso ${concursoId} regenerada com sucesso!`);

                } catch (error) {
                    console.error('Erro ao regenerar:', error);
                    ProgressOverlay.errorStep(ProgressOverlay._currentStep, error.message);
                    ProgressOverlay.finish(false, `Erro: ${error.message}`);
                }
            }
        };

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page');
            if (page) State.currentRoute = page;
            Auth.init();
            Router.renderMenu();
            Router.render();
            
            // Carregar dados do Firestore
            DataLoader.carregarConcursoAtual();
            DataLoader.carregarConcursoAnterior();
            
            // Carregar alertas e concursos se estiver na página admin
            if (State.currentRoute === 'admin' && Auth.user) {
                setTimeout(() => {
                    AdminActions.carregarAlertas();
                    AdminActions.carregarConcursosParaRegen();
                }, 1000);
            }
        });
    </script>
</body>
</html>
